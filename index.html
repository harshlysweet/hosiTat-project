<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#dc3545" />
    <title>HosiTat - Professional Hospital Finder</title>

    <!-- Leaflet core -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

    <!-- Leaflet Heat -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <!-- Leaflet Routing Machine -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- i18next for translations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.11.5/i18next.min.js"></script>

    <!-- Starability (star ratings) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/starability/2.4.2/starability-all.min.css"
    />

    <!-- lazysizes (lazy-load images) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js"
      async
    ></script>
    <link
      rel="icon"
      href="ChatGPT Image Sep 12, 2025, 11_31_46 PM.png"
      type="image/png"
    />

    <style>
      :root {
        --primary: #dc3545;
        --bg: #f8f9fa;
        --surface: #ffffff;
        --text: #212529;
        --muted: #6c757d;
        --border: #dee2e6;
        --chip: #e9ecef;
        --chip-strong: #f1f3f5;
        --accent-green: #28a745;
        --accent-orange: #fd7e14;
        --accent-red: #dc3545;
        --shadow: rgba(0, 0, 0, 0.1);
        --btn-bg: var(--chip);
        --btn-text: var(--text);
        --btn-border: var(--border);
        --btn-hover-bg: var(--chip-strong);
      }
      [data-theme="dark"] {
        --primary: #dc3545;
        --bg: #121212;
        --surface: #1a1a1a;
        --text: #e9ecef;
        --muted: #adb5bd;
        --border: #2b2b2b;
        --chip: #2a2a2a;
        --chip-strong: #2f2f2f;
        --accent-green: #34c759;
        --accent-orange: #ff9f0a;
        --accent-red: #dc3545;
        --shadow: rgba(0, 0, 0, 0.5);
        --btn-bg: #000000;
        --btn-text: #ffffff;
        --btn-border: #000000;
        --btn-hover-bg: #1c1c1c;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      header {
        background: var(--primary);
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px var(--shadow);
        z-index: 1000;
        position: relative;
      }
      header h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
      }
      .tagline {
        font-size: 13px;
        opacity: 0.9;
        margin-top: 2px;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        background: var(--btn-bg);
        color: var(--btn-text);
        padding: 10px 16px;
        border-radius: 24px;
        border: 1px solid var(--btn-border);
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease,
          border-color 0.2s ease;
      }
      .btn:hover {
        background: var(--btn-hover-bg);
        transform: translateY(-1px);
      }
      .btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        transform: none;
      }
      .btn-ghost {
        background: transparent;
        color: var(--text);
        border: 1px dashed var(--border);
      }
      .btn-danger {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .btn-danger:hover {
        filter: brightness(0.95);
      }
      .btn-loc {
        background: #dc3545;
        color: #ffffff;
        border: 1px solid #dc3545;
      }
      .btn-loc:hover {
        filter: brightness(0.95);
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #ffffff;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
      }
      /* Mobile header menu */
      .menu-toggle {
        display: none;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 18px;
        min-height: 44px;
        min-width: 44px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .menu-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      @media (max-width: 600px) {
        .menu-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        
        .mobile-lang-select {
          display: block !important;
          min-height: 44px;
          padding: 8px 12px;
          font-size: 15px;
          border-radius: 8px;
        }

        .header-actions {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: var(--primary);
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          max-height: 0;
          overflow: hidden;
          opacity: 0;
          transition: max-height 0.3s ease, opacity 0.25s ease;
          z-index: 50;
          padding: 0 14px;
        }
        .header-actions.open {
          max-height: 200px;
          opacity: 1;
          padding: 14px;
        }
        .header-actions.open > * {
          margin-bottom: 12px;
        }
        .header-actions.open {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }
        
        /* Make header relative for absolute positioning */
        header {
          position: relative;
        }
        
        /* Hide desktop language selector on mobile */
        #langSelect {
          display: none !important;
        }
        
        /* Hide tagline on mobile */
        .tagline {
          display: none !important;
        }
      }
      .toggle input {
        display: none;
      }
      .toggle .knob {
        width: 42px;
        height: 24px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.35);
        position: relative;
        transition: background 0.2s ease;
      }
      .toggle .dot {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #ffffff;
        transition: left 0.2s ease;
      }
      .toggle input:checked + .knob .dot {
        left: 21px;
      }

      .search-section {
        text-align: center;
        padding: 36px 20px 20px 20px;
        background: linear-gradient(135deg, #ffe5e5, #fff0f0);
      }
      [data-theme="dark"] .search-section {
        background: linear-gradient(135deg, #2a1214, #1d0f10);
      }

      .search-section h2 {
        color: var(--primary);
        margin-bottom: 16px;
        font-size: 26px;
      }
      .search-controls {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 12px;
        max-width: 900px;
        margin: 0 auto 18px auto;
      }
      .search-input-container {
        position: relative;
        width: 100%;
      }
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 2000;
        display: none;
        box-shadow: 0 4px 12px var(--shadow);
      }
      .search-input:focus + .autocomplete-dropdown,
      .autocomplete-dropdown:hover {
        display: block;
      }
      .autocomplete-item {
        padding: 12px 14px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
      }
      .autocomplete-item:hover {
        background: var(--chip);
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .autocomplete-text {
        color: var(--text);
        font-size: 14px;
      }
      .autocomplete-type {
        background: var(--primary);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      .autocomplete-type.hospital {
        background: var(--accent-green);
      }
      .autocomplete-type.city {
        background: var(--primary);
      }
      .search-input,
      .select {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 15px;
        width: 100%;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      .search-input:focus,
      .select:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
        border-color: var(--primary);
      }
      .mic-btn {
        border-radius: 10px;
        padding: 0 12px;
      }

      .control-bar {
        max-width: 900px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: center;
      }
      .control-bar > div:first-child {
        display: flex;
        align-items: center;
      }
      .control-bar > div:last-child {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }
      .checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }

      .filter-section {
        background: var(--surface);
        padding: 18px;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 4px var(--shadow);
      }
      .filter-group {
        margin-bottom: 12px;
      }
      .filter-label {
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text);
        display: block;
        font-size: 14px;
      }
      .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .filter-btn {
        background: var(--chip);
        color: var(--text);
        padding: 7px 14px;
        border: 1px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
      }
      .filter-btn:hover {
        background: var(--chip-strong);
      }
      .filter-btn.active {
        background: var(--primary);
        color: #ffffff;
        border-color: var(--primary);
      }

      .stats-section {
        display: flex;
        justify-content: center;
        gap: 24px;
        padding: 18px;
        background: var(--surface);
        margin: 16px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px var(--shadow);
      }
      .stat-item {
        text-align: center;
        padding: 10px;
      }
      .stat-number {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
      }
      .stat-label {
        font-size: 13px;
        color: var(--muted);
        margin-top: 4px;
      }
      .trend {
        font-size: 12px;
        color: var(--muted);
      }

      .map-wrap {
        max-width: 1100px;
        margin: 0 auto 16px auto;
        padding: 0 20px;
        display: grid;
        gap: 8px;
      }
      #mainMap {
        width: 100%;
        height: 360px;
        border-radius: 10px;
        border: 1px solid var(--border);
      }

      .hospital-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 18px;
        padding: 20px;
        justify-content: center;
      }
      
      /* Mobile hospital cards optimization */
      @media (max-width: 768px) {
        .hospital-list {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 4vw 2vw;
          gap: 4vw;
          width: 100vw;
          margin: 0;
          box-sizing: border-box;
        }
        
        .hospital {
          width: 90vw;
          max-width: 400px;
          margin: 0;
        }
        
        /* Mobile Layout - Phone Breakpoint */
        body.with-results .main-layout {
          padding: 8px;
        }
        
        body.with-results .results-container {
          width: 100%;
          margin: 0;
          padding: 0;
        }
        
        body.with-results .advanced-filters-wrap {
          width: 100%;
          margin: 0 0 16px 0;
          padding: 12px;
        }
        
        body.with-results #hospital-list {
          padding: 0;
          width: 100%;
        }
        
        body.with-results .hospital-list {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4vw;
          padding: 0;
          width: 100%;
        }
        
        .hospital {
          width: 92vw;
          max-width: 380px;
        }
        
        body.with-results #statsSection {
          margin: 0 0 12px 0;
          padding: 0;
        }
        
        body.with-results #filterSection {
          margin: 0 0 12px 0;
          padding: 0;
        }
      }
      /* Desktop Layout - Two Column Side-by-Side */
      body.with-results .main-layout {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        gap: 24px;
        align-items: flex-start;
      }
      
      body.with-results .left-column {
        width: 320px;
        flex-shrink: 0;
        background: var(--bg);
        align-self: flex-start;
      }
      
      body.with-results .advanced-filters-wrap {
        width: 100%;
        background: var(--bg);
        padding: 0;
        margin: 0;
        display: block !important;
        border: none;
        position: sticky;
        top: 20px;
      }
      
      body.with-results .results-container {
        flex: 1;
        padding: 0;
        margin: 0;
      }
      
      body.with-results #hospital-list {
        margin: 0;
        padding: 0;
      }
      
      body.with-results .hospital-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 0;
        margin: 0;
      }
      
      .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      
      /* Stats and filter sections stay in original position */
      body.with-results #statsSection {
        margin: 0 auto 20px auto;
        max-width: 1200px;
        padding: 0 20px;
      }
      
      body.with-results #filterSection {
        margin: 0 auto 20px auto;
        max-width: 1200px;
        padding: 0 20px;
      }
      .skeleton {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        height: 260px;
        position: relative;
      }
      .shimmer {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0.08),
          rgba(255, 255, 255, 0)
        );
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .hospital {
        background: var(--surface);
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 4px 12px var(--shadow);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        border: 1px solid var(--border);
        opacity: 0;
        transform: translateY(8px);
      }
      .hospital:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 22px var(--shadow);
      }
      .hospital.animate {
        animation: fadeUp 0.45s ease forwards;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .hospital.emergency {
        border: 2px solid var(--primary);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.25);
      }
      .hospital.emergency::before {
        content: "EMERGENCY";
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--primary);
        color: #ffffff;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 800;
        z-index: 10;
      }
      .select-compare {
        position: absolute;
        left: 10px;
        top: 10px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 12px;
        z-index: 10;
      }
      .hospital-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #ced4da;
      }
      .hospital-content {
        padding: 16px;
      }
      .hospital-name {
        font-size: 17px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .favorite-btn {
        border: 1px solid var(--border);
        background: var(--chip-strong);
        color: var(--text);
        border-radius: 14px;
        padding: 4px 9px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .favorite-btn.active {
        background: #2a2a2a;
        color: #ffd6db;
        border-color: #3a3a3a;
      }
      [data-theme="light"] .favorite-btn.active {
        background: #ffe3e6;
        color: #c2255c;
      }

      .hospital-specialties {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
      }
      .specialty-tag {
        background: var(--chip);
        color: var(--text);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        border: 1px solid var(--border);
      }
      .hospital-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 13px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 6px;
        background: var(--chip);
        border-radius: 6px;
        border: 1px solid var(--border);
      }

      .status-good {
        color: var(--accent-green);
        font-weight: 700;
      }
      .status-moderate {
        color: var(--accent-orange);
        font-weight: 700;
      }
      .status-critical {
        color: var(--accent-red);
        font-weight: 700;
      }

      .compare-bar {
        position: sticky;
        bottom: 0;
        z-index: 60;
        background: var(--surface);
        border-top: 2px solid var(--border);
        padding: 10px 20px;
        display: none;
      }
      .compare-items {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 4000;
        justify-content: center;
        align-items: center;
        opacity: 0;
      }
      .modal.open {
        animation: fadeBg 0.2s ease forwards;
      }
      @keyframes fadeBg {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .modal-content {
        background: var(--surface);
        color: var(--text);
        border-radius: 14px;
        width: 95%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        border: 1px solid var(--border);
        transform: scale(0.98);
        opacity: 0;
      }
      .modal.open .modal-content {
        animation: popIn 0.25s ease forwards;
      }
      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Button focus for accessibility */
      .btn:focus-visible,
      .favorite-btn:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
      }

      /* Animate hamburger to X */
      .menu-toggle {
        transition: all 0.2s ease;
      }
      .menu-toggle.open {
        transform: rotate(90deg);
        background: rgba(255, 255, 255, 0.3);
      }
      
      /* Touch-friendly interactions */
      @media (hover: none) and (pointer: coarse) {
        .hospital:hover {
          transform: none;
          box-shadow: 0 4px 12px var(--shadow);
        }
        .btn:hover {
          transform: none;
        }
        .filter-btn:hover {
          background: var(--chip-strong);
        }
      }
      
      /* Active states for touch */
      .btn:active {
        transform: scale(0.98);
      }
      .hospital:active {
        transform: scale(0.99);
      }
      .filter-btn:active {
        transform: scale(0.98);
      }
      .modal-header {
        background: linear-gradient(135deg, var(--primary), #c82333);
        color: #ffffff;
        padding: 14px 16px;
        border-radius: 14px 14px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .close-btn {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 24px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .close-btn:hover {
        background: rgba(255, 255, 255, 0.18);
      }
      .modal-body {
        padding: 16px;
      }
      .hospital-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 12px;
      }
      #previewMap {
        height: 260px;
        width: 100%;
        border-radius: 10px;
        margin-top: 8px;
        border: 1px solid var(--border);
      }
      .detail-section {
        background: var(--chip);
        border: 1px solid var(--border);
        padding: 14px;
        border-radius: 10px;
      }
      .detail-section h3 {
        color: var(--primary);
        margin-bottom: 10px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 6px;
      }
      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }
      .detail-row:last-child {
        border-bottom: none;
      }
      #map {
        height: 300px;
        width: 100%;
        border-radius: 10px;
        margin-top: 12px;
      }
      #routeMap {
        height: 320px;
        width: 100%;
        border-radius: 10px;
        margin-top: 12px;
      }

      .reviews {
        display: grid;
        gap: 8px;
      }
      .review {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
      }
      .review-form {
        display: grid;
        gap: 8px;
        margin-top: 8px;
      }
      .review-form textarea {
        width: 100%;
        min-height: 60px;
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 8px;
        padding: 8px;
      }

      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.45);
        z-index: 5000;
        justify-content: center;
        align-items: center;
      }
      .loader-card {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 16px 18px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 6px 20px var(--shadow);
      }
      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid var(--primary);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: var(--primary);
        font-weight: 800;
        font-size: 16px;
      }

      .landing {
        padding: 22px 20px;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px var(--shadow);
      }
      .card h3 {
        color: var(--primary);
        margin-bottom: 10px;
        font-size: 18px;
      }
      .resources {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 12px;
      }
      .resource {
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .resource a {
        color: var(--text);
        font-weight: 700;
        text-decoration: none;
      }
      .resource p {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
      }

      .quotes {
        display: grid;
        gap: 12px;
      }
      .quote {
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        font-style: italic;
        color: var(--text);
      }
      .quote small {
        display: block;
        margin-top: 6px;
        color: var(--muted);
        font-style: normal;
      }

      .faq {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 20px 20px 20px;
      }
      .faq details {
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
      }
      .faq summary {
        cursor: pointer;
        font-weight: 700;
        color: var(--text);
      }

      .chatbot-fab {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 70;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        box-shadow: 0 8px 22px var(--shadow);
        font-weight: 800;
        transition: all 0.2s ease;
      }
      .chatbot-fab:active {
        transform: scale(0.95);
      }
      @media (max-width: 600px) {
        .chatbot-fab {
          right: 16px;
          bottom: 16px;
          width: 52px;
          height: 52px;
        }
      }
      .chatbot-modal .modal-content {
        max-width: 520px;
      }
      .chat-ui {
        display: grid;
        gap: 8px;
      }
      .chat-log {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        height: 260px;
        overflow: auto;
      }
      .chat-input-row {
        display: flex;
        gap: 8px;
      }
      .chat-input-row input {
        flex: 1;
      }

      footer {
        margin-top: 24px;
        background: #0c0c0c;
        color: #e9ecef;
        padding: 24px 20px 10px 20px;
        border-top: 2px solid var(--primary);
        clear: both;
      }
      .footer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
        margin-bottom: 14px;
      }
      .footer h4 {
        color: #ffffff;
        margin-bottom: 10px;
        font-size: 16px;
      }
      .footer a {
        color: #cfd3d7;
        text-decoration: none;
        font-size: 14px;
      }
      .footer a:hover {
        color: #ffffff;
        text-decoration: underline;
      }
      .socials {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }
      .social-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #141414;
        border: 1px solid #232323;
        cursor: pointer;
      }
      .social-btn:hover {
        background: #1c1c1c;
      }
      .copyright {
        border-top: 1px solid #1e1e1e;
        margin-top: 10px;
        padding-top: 10px;
        color: #a5a5a5;
        font-size: 12px;
      }

      @media (max-width: 900px) {
        .search-controls {
          grid-template-columns: 1fr;
        }
        .search-controls .btn {
          width: 100%;
          margin-top: 8px;
        }
        .control-bar {
          grid-template-columns: 1fr;
        }
        .landing {
          grid-template-columns: 1fr;
        }
        .hospital-detail-grid {
          grid-template-columns: 1fr;
        }
        header {
          flex-direction: column;
          gap: 10px;
          text-align: center;
        }
        
        /* Mobile Layout - Tablet Breakpoint */
        body.with-results .main-layout {
          display: block;
          padding: 16px;
          margin: 0;
        }
        
        body.with-results .results-container {
          padding: 0;
          margin: 0;
        }
        
        body.with-results .advanced-filters-wrap {
          width: 100%;
          margin: 0 0 20px 0;
          position: relative;
          background: var(--surface);
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 4px 12px var(--shadow);
          border-right: none;
        }
        
        body.with-results #hospital-list {
          margin: 0;
          padding: 0;
        }
        
        body.with-results .hospital-list {
          display: grid;
          grid-template-columns: 1fr;
          gap: 20px;
          justify-items: center;
          margin: 0;
          padding: 0;
        }
        
        .hospital {
          width: 100%;
          max-width: 400px;
        }
        
        body.with-results #statsSection {
          margin: 0 0 16px 0;
          padding: 0;
        }
        
        body.with-results #filterSection {
          margin: 0 0 16px 0;
          padding: 0;
        }
      }
      /* Tablet */
      @media (max-width: 768px) {
        header {
          padding: 12px 16px;
        }
        .header-actions {
          width: 100%;
          justify-content: center;
          gap: 8px;
          flex-wrap: wrap;
        }
        .hospital-list {
          grid-template-columns: 1fr;
          gap: 16px;
          padding: 16px;
        }
        .results-container {
          max-width: 100%;
          margin: 0;
          min-height: auto;
        }
        body.with-results .advanced-filters-wrap {
          width: 100%;
          float: none;
          margin: 10px 16px;
        }
        body.with-results #hospital-list {
          margin-left: 0;
        }
        .hospital-image {
          width: 100%;
          aspect-ratio: 16/9;
          height: auto;
          object-fit: cover;
        }
        .btn {
          padding: 9px 13px;
          font-size: 14px;
        }
        .search-input,
        .select {
          padding: 10px 12px;
          font-size: 14px;
        }
      }
      
      /* Mobile-first refinements */
      @media (max-width: 600px) {
        body {
          line-height: 1.5;
        }
        header {
          padding: 12px 14px;
        }
        header h1 {
          font-size: 20px;
        }
        .tagline {
          font-size: 12px;
          display: none !important;
        }
        
        /* Hide control bar on mobile */
        .control-bar {
          display: none !important;
        }
        .header-actions {
          width: 100%;
          justify-content: center;
          gap: 8px;
        }
        .header-actions .btn {
          padding: 10px 14px;
          font-size: 15px;
          min-height: 44px; /* Better touch target */
          border-radius: 8px;
        }
        #langSelect {
          min-width: 0;
          width: 100%;
          display: none !important;
        }

        .search-section {
          padding: 20px 14px 14px 14px;
        }
        .search-section h2 {
          font-size: 22px;
          margin-bottom: 20px;
        }
        .search-input,
        .select {
          padding: 14px 16px;
          font-size: 16px; /* Prevents zoom on iOS */
          min-height: 48px;
          border-radius: 8px;
        }
        .btn {
          padding: 12px 16px;
          font-size: 15px;
          min-height: 48px;
          border-radius: 8px;
        }
        .mic-btn {
          min-height: 48px;
          width: 48px;
        }

        .stats-section {
          margin: 10px 14px;
          gap: 12px;
          padding: 16px;
          flex-wrap: wrap;
        }
        .stat-item {
          min-width: calc(50% - 6px);
          padding: 12px;
        }
        .stat-number {
          font-size: 20px;
        }

        /* Advanced filters move below and full width */
        body.with-results .advanced-filters-wrap {
          width: 100%;
          margin: 0 0 16px 0;
          padding: 12px;
        }
        
        body.with-results #hospital-list {
          margin: 0;
          padding: 0;
          width: 100%;
        }

        .hospital-list {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 5vw;
          padding: 2vw;
          width: 100%;
          margin: 0;
          box-sizing: border-box;
        }
        
        .hospital {
          border-radius: 12px;
          box-shadow: 0 2px 8px var(--shadow);
          width: 94vw;
          max-width: 380px;
          margin: 0;
        }
        .hospital:hover {
          transform: none;
        }
        .hospital-image {
          width: 100%;
          height: 45vw;
          max-height: 200px;
          object-fit: cover;
        }
        .hospital-content {
          padding: 4vw;
        }
        .hospital-name {
          font-size: clamp(16px, 4.5vw, 18px);
          line-height: 1.3;
          margin-bottom: 3vw;
        }
        .favorite-btn {
          padding: 2vw 3vw;
          font-size: clamp(11px, 3vw, 13px);
          min-height: 8vw;
        }
        .hospital-specialties {
          margin-bottom: 3vw;
        }
        .specialty-tag {
          padding: 1.5vw 3vw;
          font-size: clamp(10px, 3vw, 12px);
          margin-right: 2vw;
          margin-bottom: 2vw;
        }
        .hospital-info {
          gap: 2.5vw;
        }
        .info-item {
          padding: 2.5vw 3vw;
          font-size: clamp(11px, 3.5vw, 13px);
          border-radius: 8px;
        }

        /* Modal optimizations for mobile */
        .modal {
          padding: 0;
          align-items: flex-start;
        }
        .modal-content {
          width: 100vw;
          height: 100vh;
          max-width: none;
          max-height: none;
          margin: 0;
          border-radius: 0;
          overflow-y: auto;
        }
        .modal-header {
          padding: 4vw 5vw;
          border-radius: 0;
          position: sticky;
          top: 0;
          z-index: 10;
        }
        .modal-header h2 {
          font-size: clamp(18px, 5vw, 22px);
          line-height: 1.3;
        }
        .close-btn {
          width: 12vw;
          height: 12vw;
          min-width: 44px;
          min-height: 44px;
          font-size: 6vw;
        }
        .modal-body {
          padding: 5vw;
          background: var(--bg);
        }
        .hospital-detail-grid {
          display: flex;
          flex-direction: column;
          gap: 6vw;
        }
        .detail-section {
          padding: 5vw;
          background: var(--surface);
          border-radius: 3vw;
          border: 1px solid var(--border);
        }
        .detail-section h3 {
          font-size: clamp(16px, 5vw, 20px);
          margin-bottom: 4vw;
          color: var(--primary);
          border-bottom: 2px solid var(--border);
          padding-bottom: 2vw;
        }
        .detail-row {
          padding: 3vw 0;
          font-size: clamp(14px, 4vw, 16px);
          border-bottom: 1px solid var(--border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .detail-row:last-child {
          border-bottom: none;
        }
        .detail-row strong {
          font-weight: 600;
          color: var(--text);
        }
        #routeMap,
        #map,
        #previewMap {
          height: 70vw;
          max-height: 300px;
          border-radius: 3vw;
          margin-top: 3vw;
          border: 2px solid var(--border);
        }

        /* Filter section mobile optimization */
        .filter-section {
          padding: 16px;
        }
        .filter-buttons {
          gap: 10px;
        }
        .filter-btn {
          padding: 10px 16px;
          font-size: 14px;
          min-height: 40px;
          border-radius: 8px;
        }

        /* Compare bar mobile */
        .compare-bar {
          padding: 12px 16px;
        }
        .compare-items {
          gap: 8px;
        }
        .pill {
          font-size: 12px;
          padding: 4px 10px;
        }

        /* Map container mobile */
        .map-wrap {
          padding: 0 16px;
        }
        #mainMap {
          height: 300px;
          border-radius: 8px;
        }

        /* Touch-friendly checkboxes */
        .checkbox {
          padding: 8px 0;
        }
        .checkbox input[type="checkbox"] {
          width: 18px;
          height: 18px;
        }

        /* Better spacing for advanced filters */
        .advanced-filters-wrap details {
          padding: 16px;
        }
        .advanced-filters-wrap summary {
          font-size: 16px;
          padding: 8px 0;
        }
        .filter-label {
          font-size: 15px;
          margin-bottom: 10px;
        }
        
        /* Range inputs mobile optimization */
        input[type="range"] {
          height: 6px;
          -webkit-appearance: none;
          appearance: none;
          background: var(--border);
          border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: var(--primary);
          cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: var(--primary);
          cursor: pointer;
          border: none;
        }
      }
      /* Small phones */
      @media (max-width: 480px) {
        header h1 {
          font-size: 18px;
        }
        .btn {
          padding: 8px 10px;
          font-size: 13px;
        }
        .search-section h2 {
          font-size: 18px;
        }
        .stats-section {
          gap: 10px;
        }
      }
      /* Very small phones optimization */
      @media (max-width: 375px) {
        .hospital {
          width: 95vw;
        }
        .hospital-content {
          padding: 4vw;
        }
        .hospital-name {
          font-size: clamp(15px, 4.5vw, 17px);
        }
        .modal-content {
          width: 100vw;
        }
        .modal-body {
          padding: 4vw;
        }
        .detail-section {
          padding: 4vw;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>
          <a
            href="#"
            onclick="goHome(); return false;"
            style="color: inherit; text-decoration: none"
            >HosiTat</a
          >
        </h1>
        <div class="tagline" id="tagline">
          Professional Hospital & Emergency Care Finder
        </div>
      </div>
      <div class="mobile-header-right" style="display: flex; align-items: center; gap: 10px;">
        <select
          class="select mobile-lang-select"
          id="mobileLangSelect"
          onchange="setLang(this.value)"
          aria-label="Select language"
          style="display: none; min-width: 100px;"
        >
          <option value="en">EN</option>
          <option value="hi">हि</option>
        </select>
        <button
          class="btn menu-toggle"
          onclick="toggleHeaderMenu()"
          aria-label="Menu"
          style="display: none"
        >
          ☰
        </button>
      </div>
      <div class="header-actions" role="group" aria-label="Header actions">
        <!--
        <label class="toggle" title="Toggle dark mode">
          <input
            id="themeToggle"
            type="checkbox"
            onchange="toggleTheme(this)"
          />
          <span class="knob"><span class="dot"></span></span>
          <span>Dark Mode</span>
        </label>
        -->
        <button class="btn" onclick="window.location.href='tel:108'">
          Call Ambulance
        </button>
        <!-- <button class="btn" onclick="openSignInModal()">Sign In</button> -->
        <select
          class="select"
          id="langSelect"
          onchange="setLang(this.value)"
          aria-label="Select language"
          style="width: auto; min-width: 140px"
        >
          <option value="en">English</option>
          <option value="hi">हिन्दी (Hindi)</option>
        </select>
      </div>
    </header>

    <div class="search-section" aria-label="Search section">
      <h2 id="searchTitle">Find Healthcare Facilities Near You</h2>
      <form
        class="search-controls"
        onsubmit="event.preventDefault(); searchHospitals();"
      >
        <div class="search-input-container">
          <input
            id="searchInput"
            class="search-input"
            type="text"
            placeholder="Search by hospital name or city"
            aria-label="Search hospitals"
            autocomplete="off"
          />
          <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
        </div>
        <button id="searchBtn" type="submit" class="btn">Search</button>
        <button id="locBtn" class="btn btn-loc" onclick="findHospitals()">
          Search by Location
        </button>
      </form>

      <div class="control-bar">
        <div>
          <label class="checkbox" title="Show only favorites">
            <input
              id="favoritesOnly"
              type="checkbox"
              onchange="applyFilters()"
            />
            <span>Show favorites only</span>
          </label>
        </div>
        <div>
          <button class="btn" onclick="exportFavoritesCsv()">
            Export favorites (CSV)
          </button>
          <button class="btn" onclick="exportResultsPdf()">
            Export results (PDF)
          </button>
        </div>
      </div>
    </div>

    <div
      id="advancedFilters"
      class="advanced-filters-wrap"
      style="display: none"
    >
      <details open>
        <summary id="advancedFiltersSummary">Advanced filters</summary>
        <div style="display: grid; gap: 10px; margin-top: 8px">
          <label class="filter-label" for="sortSelect" id="sortLabel"
            >Sort</label
          >
          <select id="sortSelect" class="select" onchange="applyFilters()">
            <option value="distance">Sort by Distance</option>
            <option value="rating">Sort by Rating</option>
            <option value="beds">Sort by Available Beds</option>
          </select>
          <div>
            <label class="filter-label" for="filterCity">City</label>
            <input
              id="filterCity"
              class="search-input"
              type="text"
              placeholder="City"
              oninput="applyFilters()"
            />
          </div>
          <div>
            <label class="filter-label" for="filterState">State</label>
            <input
              id="filterState"
              class="search-input"
              type="text"
              placeholder="State"
              oninput="applyFilters()"
            />
          </div>
          <div>
            <label class="filter-label" for="filterInsurance">Insurance</label>
            <input
              id="filterInsurance"
              class="search-input"
              type="text"
              placeholder="Insurance accepted (e.g., PM-JAY)"
              oninput="applyFilters()"
            />
          </div>
          <div class="filter-group">
            <span class="filter-label">Facilities</span>
            <div class="filter-buttons" style="display: grid; gap: 6px">
              <label class="checkbox"
                ><input
                  id="filter247"
                  type="checkbox"
                  onchange="applyFilters()"
                />
                <span>24/7 Emergency</span></label
              >
              <label class="checkbox"
                ><input
                  id="filterICU"
                  type="checkbox"
                  onchange="applyFilters()"
                />
                <span>ICU</span></label
              >
              <label class="checkbox"
                ><input
                  id="filterBlood"
                  type="checkbox"
                  onchange="applyFilters()"
                />
                <span>Blood Bank</span></label
              >
              <label class="checkbox"
                ><input
                  id="filterAmbulance"
                  type="checkbox"
                  onchange="applyFilters()"
                />
                <span>Ambulance</span></label
              >
              <label class="checkbox"
                ><input
                  id="filterRadiology"
                  type="checkbox"
                  onchange="applyFilters()"
                />
                <span>Radiology</span></label
              >
            </div>
          </div>
          <div>
            <label
              class="filter-label"
              for="distanceRange"
              id="distanceTextLabel"
              >Max Distance (km): <span id="distanceLabel">0–20</span></label
            >
            <input
              id="distanceRange"
              type="range"
              min="1"
              max="50"
              value="20"
              oninput="updateDistanceLabel(this.value)"
              onchange="applyFilters()"
              style="width: 100%"
            />
          </div>
          <div>
            <label class="filter-label" for="minRating" id="ratingTextLabel"
              >Min Rating: <span id="ratingLabel">0</span></label
            >
            <input
              id="minRating"
              type="range"
              min="0"
              max="5"
              step="0.5"
              value="0"
              oninput="updateRatingLabel(this.value)"
              onchange="applyFilters()"
              style="width: 100%"
            />
          </div>
          <div>
            <label class="filter-label" for="minBeds" id="bedsTextLabel"
              >Min Available Beds: <span id="bedsLabel">0</span></label
            >
            <input
              id="minBeds"
              type="range"
              min="0"
              max="200"
              value="0"
              oninput="updateBedsLabel(this.value)"
              onchange="applyFilters()"
              style="width: 100%"
            />
          </div>
          <button class="btn btn-ghost" onclick="resetFilters()">
            Reset filters
          </button>
        </div>
      </details>
    </div>

    <div
      id="filterSection"
      class="filter-section"
      style="display: none; text-align: center"
    >
      <div class="filter-group">
        <span id="filterTypeLabel" class="filter-label">Hospital Type:</span>
        <div class="filter-buttons" style="justify-content: center">
          <button
            id="typeAllBtn"
            class="filter-btn active"
            onclick="filterByType('all', this)"
          >
            All Hospitals
          </button>
          <button
            id="typeEmergencyBtn"
            class="filter-btn"
            onclick="filterByType('emergency', this)"
          >
            Emergency
          </button>
          <button
            id="typeGeneralBtn"
            class="filter-btn"
            onclick="filterByType('general', this)"
          >
            General
          </button>
        </div>
      </div>
      <div class="filter-group">
        <span id="filterSpecLabel" class="filter-label">Specialization:</span>
        <div class="filter-buttons" style="justify-content: center">
          <button
            id="specAllBtn"
            class="filter-btn active"
            onclick="filterBySpecialty('all', this)"
          >
            All Specialties
          </button>
          <button
            id="specCardiologyBtn"
            class="filter-btn"
            onclick="filterBySpecialty('cardiology', this)"
          >
            Cardiology
          </button>
          <button
            id="specNeurologyBtn"
            class="filter-btn"
            onclick="filterBySpecialty('neurology', this)"
          >
            Neurology
          </button>
          <button
            id="specRadiologyBtn"
            class="filter-btn"
            onclick="filterBySpecialty('radiology', this)"
          >
            Radiology
          </button>
          <button
            id="specOrthopedicsBtn"
            class="filter-btn"
            onclick="filterBySpecialty('orthopedics', this)"
          >
            Orthopedics
          </button>
          <button
            id="specPediatricsBtn"
            class="filter-btn"
            onclick="filterBySpecialty('pediatrics', this)"
          >
            Pediatrics
          </button>
          <button
            id="specOncologyBtn"
            class="filter-btn"
            onclick="filterBySpecialty('oncology', this)"
          >
            Oncology
          </button>
          <button
            id="specSurgeryBtn"
            class="filter-btn"
            onclick="filterBySpecialty('surgery', this)"
          >
            Surgery
          </button>
        </div>
      </div>
    </div>

    <div id="statsSection" class="stats-section" style="display: none">
      <div class="stat-item">
        <div class="stat-number" id="totalHospitals">0</div>
        <div class="stat-label">Total Found</div>
        <div class="trend" id="trendTotal"></div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="emergencyCount">0</div>
        <div class="stat-label">Emergency</div>
        <div class="trend" id="trendEmergency"></div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="averageDistance">0</div>
        <div class="stat-label">Avg Distance (km)</div>
        <div class="trend" id="trendDistance"></div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="availableBeds">0</div>
        <div class="stat-label">Available Beds</div>
        <div class="trend" id="trendBeds"></div>
      </div>
    </div>

    <section id="landing" class="landing" aria-label="Landing">
      <div class="card" id="welcomeCard">
        <h3>Trusted Government & Health Resources</h3>
        <div class="resources">
          <div class="resource">
            <a href="https://www.nhp.gov.in/" target="_blank" rel="noopener"
              >National Health Portal (India)</a
            >
            <p>
              Official health information, hospitals, schemes, and services.
            </p>
          </div>
          <div class="resource">
            <a href="https://pmjay.gov.in/" target="_blank" rel="noopener"
              >Ayushman Bharat PM-JAY</a
            >
            <p>
              Government health insurance scheme details and empaneled
              hospitals.
            </p>
          </div>
          <div class="resource">
            <a href="https://www.mohfw.gov.in/" target="_blank" rel="noopener"
              >Ministry of Health & Family Welfare</a
            >
            <p>Official advisories, programs, and health updates from MoHFW.</p>
          </div>
          <div class="resource">
            <a href="https://data.gov.in/" target="_blank" rel="noopener"
              >data.gov.in</a
            >
            <p>
              Open government datasets, including health and hospital
              information.
            </p>
          </div>
          <div class="resource">
            <a href="https://www.icmr.gov.in/" target="_blank" rel="noopener"
              >ICMR</a
            >
            <p>Indian Council of Medical Research guidelines and research.</p>
          </div>
          <div class="resource">
            <a href="https://www.nhsrcindia.org/" target="_blank" rel="noopener"
              >NHSRC</a
            >
            <p>National Health Systems Resource Centre resources and tools.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Medical Quotes</h3>
        <div class="quotes" id="quotesContainer">
          <div class="quote">
            "Wherever the art of Medicine is loved, there is also a love of
            Humanity."<small>— Hippocrates</small>
          </div>
          <div class="quote">
            "The good physician treats the disease; the great physician treats
            the patient who has the disease."<small>— William Osler</small>
          </div>
          <div class="quote">
            "To cure sometimes, to relieve often, to comfort always."<small
              >— Edward Livingston Trudeau</small
            >
          </div>
        </div>
      </div>
    </section>

    <div id="noResultsSection" style="display: none; text-align: center; padding: 40px; margin: 20px auto; max-width: 600px; min-height: 300px;">
      <div class="card" style="padding: 40px;">
        <h3 id="noResultsTitle">No hospitals found matching your criteria</h3>
        <p id="noResultsText" style="color: var(--muted); margin-top: 10px;">
          Try adjusting your filters or search in a different area.
        </p>
      </div>
    </div>

    <div class="main-layout">
      <div class="left-column">
        <!-- Advanced filters will be moved here by JavaScript on desktop -->
      </div>
      <div class="results-container">
        <div id="hospital-list" class="hospital-list" aria-live="polite"></div>
      </div>
    </div>

    <div id="loading">
      <div class="loader-card">
        <div class="spinner"></div>
        <div class="loading-text">Finding Nearby Hospitals...</div>
      </div>
    </div>

    <div
      id="hospitalModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalHospitalName"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalHospitalName">Hospital Details</h2>
          <button class="close-btn" onclick="closeHospitalModal()">×</button>
        </div>
        <div class="modal-body">
          <div id="modalContent"></div>
        </div>
      </div>
    </div>

    <div
      id="compareModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="compareTitle"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="compareTitle">Compare Hospitals</h2>
          <button class="close-btn" onclick="closeCompare()">×</button>
        </div>
        <div class="modal-body" id="compareBody"></div>
      </div>
    </div>

    <div
      id="signModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="signTitle"
    >
      <div class="modal-content" style="max-width: 420px">
        <div class="modal-header">
          <h2 id="signTitle">Sign In to HosiTat</h2>
          <button class="close-btn" onclick="closeSignInModal()">×</button>
        </div>
        <div class="modal-body">
          <form id="signForm" aria-label="Sign in form">
            <input
              type="email"
              id="email"
              class="search-input"
              placeholder="Enter Email"
              required
            />
            <input
              type="password"
              id="password"
              class="search-input"
              placeholder="Enter Password"
              required
            />
            <div class="row">
              <input
                id="profileName"
                class="search-input"
                type="text"
                placeholder="Full name (optional)"
              />
              <input
                id="profilePhone"
                class="search-input"
                type="tel"
                placeholder="Phone (optional)"
              />
            </div>
            <button
              type="submit"
              class="btn"
              style="width: 100%; margin-top: 10px"
            >
              Sign In
            </button>
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted)">
              Your preferences and saved hospitals will be synced to this
              device.
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="compare-bar" id="compareBar">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 8px;
          flex-wrap: wrap;
        "
      >
        <div class="compare-items" id="compareItems"></div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap">
          <button class="btn" onclick="openCompare()">Open Compare</button>
          <button class="btn btn-danger" onclick="clearCompare()">Clear</button>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-grid">
        <div>
          <h4 id="aboutTitle">About HosiTat</h4>
          <p style="color: #cfd3d7">
            <span id="aboutText"
              >An open, user-first interface to discover hospitals and emergency
              care near you with transparent stats and navigation.</span
            >
          </p>
        </div>
        <div>
          <h4 id="teamTitle">Made by</h4>
          <div style="display: grid; gap: 8px">
            <div>
              <div style="font-weight: 700">Harshit Sharma</div>
              <div class="socials">
                <a
                  class="social-btn"
                  href="https://in.linkedin.com/in/harshit-sharma-56a6661b9"
                  target="_blank"
                  rel="noopener"
                  aria-label="LinkedIn"
                  title="LinkedIn"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="#cfd3d7"
                    aria-hidden="true"
                  >
                    <path
                      d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.5 8h4V24h-4zM8.5 8h3.8v2.2h.1c.5-1 1.8-2.2 3.7-2.2 4 0 4.7 2.6 4.7 6V24h-4v-7.1c0-1.7 0-3.9-2.4-3.9-2.4 0-2.8 1.9-2.8 3.8V24h-4z"
                    />
                  </svg>
                </a>
                <a
                  class="social-btn"
                  href="https://github.com/harshlysweet"
                  target="_blank"
                  rel="noopener"
                  aria-label="GitHub"
                  title="GitHub"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="#cfd3d7"
                    aria-hidden="true"
                  >
                    <path
                      d="M12 .5C5.73.5.99 5.24.99 11.5c0 4.85 3.15 8.96 7.5 10.41.55.1.75-.24.75-.53 0-.26-.01-1.11-.02-2.01-3.05.66-3.7-1.29-3.7-1.29-.5-1.28-1.22-1.62-1.22-1.62-.99-.68.08-.66.08-.66 1.1.08 1.68 1.13 1.68 1.13.97 1.66 2.55 1.18 3.17.9.1-.7.38-1.18.69-1.45-2.43-.28-4.99-1.21-4.99-5.4 0-1.19.43-2.16 1.13-2.92-.11-.28-.49-1.41.11-2.94 0 0 .92-.3 3.01 1.12A10.5 10.5 0 0 1 12 6.8c.93.01 1.87.13 2.74.38 2.09-1.42 3.01-1.12 3.01-1.12.6 1.53.22 2.66.11 2.94.7.76 1.13 1.73 1.13 2.92 0 4.2-2.57 5.12-5.01 5.39.39.34.73 1.01.73 2.03 0 1.47-.01 2.66-.01 3.02 0 .29.19.64.76.53 4.35-1.45 7.5-5.56 7.5-10.41C23.01 5.24 18.27.5 12 .5z"
                    />
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h4 id="contactTitle">Contact</h4>
          <div style="display: grid; gap: 6px">
            <a id="contactEmail" href="mailto:harshitsharma1765@gmail.com"
              >harshitsharma1765@gmail.com</a
            >
          </div>
        </div>
      </div>
      <div class="copyright">
        © <span id="year"></span> HosiTat. Built with OpenStreetMap and open web
        standards.
      </div>
    </footer>
    <script>
      function goHome() {
        try {
          // Reset to landing view without full reload
          document.getElementById("landing").style.display = "grid";
          document.getElementById("noResultsSection").style.display = "none";
          document.getElementById("hospital-list").innerHTML = "";
          document.getElementById("filterSection").style.display = "none";
          document.getElementById("statsSection").style.display = "none";
          const adv = document.getElementById("advancedFilters");
          if (adv) adv.style.display = "none";
          document.body.classList.remove("with-results");
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch {
          // fallback to reload
          location.reload();
        }
      }
      // State
      let allHospitals = [];
      let currentTypeFilter = "all";
      let currentSpecialtyFilter = "all";
      let currentSearch = "";
      let userLat = null,
        userLon = null;

      let map,
        mainMap,
        clusterLayer = null,
        heatLayer = null;
      const poiLayers = { pharmacy: null, clinic: null, atm: null };

      const FAVORITES_KEY = "hositat_favorites_v1";
      const THEME_KEY = "hositat_theme";
      const LANG_KEY = "hositat_lang";
      const PROFILE_KEY = "hositat_profile_v1";
      const REVIEWS_KEY = "hositat_reviews_v1";
      const HISTORY_KEY = "hositat_history_v1";

      let favoriteNames = new Set(loadFavorites());
      let compareSet = new Set();

      // LANGUAGE
      const FALLBACK_IMAGE = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMwAAADACAMAAAB/Pny7AAABAlBMVEX///+JkKPAx9p1eZbu8O+e2emzMkbY2eBzdpWCh597fpudpse9xNrc4Ov///3OQ1rz+PfGzeDlur6qsMeGiqVudJCZpMLw8vjNVWdpbI3Fy9qzLUHNR1ess8a1TF3n6uu/wMmDn7nWrbKPoLjEnrBmwt+Tzd2wu8t11vBUsM++uMuno7yYx9qNs8mf4O5fk7CG1euLu85wg6dtlrlzqMJbp8apPk5az+1wka6rp7nNMkebobZSxOTKO0+QqsKjXXB+c4z14OLXgIzbjJfSYnHipKyQm8KZZ3zwztDAFTn+8vbSHENzhppT1OrTzNhMoMhXnLNXirJ1uNF62+jRbn2We4+cc2IzAAAKOklEQVR4nO2cCVfaShSAA4IBJbsNmCYvoBVQC7hRNsNrIGmRql30/f+/8u6dhE0DUjUQzpnP02yM0/m8yczNJMowFAqFQqFQKBQKhUKhUCgUCoVCoVAoFAqFQqFQKBRKhODX3YD3gweXrMlxZha1Nl2M5zRFUXd3FY3bcBmeMTVVzWgcp2VUVTJJoDYWU1HjWXFo20MxK30zuE2Ojal845hB38nlnN6A4VQlu+4WvR4xDi59y2rf3LQtq89w3zKbasMzrCox/RtL6A0Gj4LQ7jOSyq67Va9FzCii3NYxJhAfQf/hisrGnmicKg0dcGl7MoLlDKVdbt2teiXcLjfQ247juAzjOs6jlRuY6qZ2aJKadS3LBngGemfbstzsrrahMhklC10ZbnljJcoomriRMry2m3V1yx4MbIbBpQAyqrYBLtkAJLxmdMfJ4TWTcxxLh2tGCioZrdya21UCUFnRgU7M680s7M0gUwsqGKleged21V31OTDOYJfsd81tOatAuecFdyMlA0MKNPI5mAH8ECzIAHqCdYMZQFCp3W+RkiGRCZJRvdwM8HKzQJeIyTBzZSA2Nsma+/a8uERNhucCLhifjCnywyEvZuNzi3zjonTTxptxJBMEuWPmJLh1DvyYfJ+5boFpePzJ8okgsuxoDoDNZoMK8Dwfpbgw/pgXKAOYJsea5rxP1930YIIj8yLrbnYwvox/LmVFfz0+tyYbor8rRl5mdGqR9k5dJuaUmAlfolcmojJwzYit1AWS2iOrfIL1NrbIsnnLJgyvwO0O7l+cimuT4ReDJ03nutG4u2vUYNVoHJcS7NUd7Dbqddy/u2LF0jHsNsqXWODuWiUyC+oM0eWFAhCZzvVZMpn83LyuAucQmatGMlmtVupn1Woy2b0XS/Uz2E8WjpJYrgNn4uL/MiwfnjfZhZDIPEAji80GtrVCIpMEi0q9jAe6LJHBAkdk1YHLZ3GdYQ2nPN/aX8SOKSa8yBSb19j285IXmRmZYyyQJDLVzyiztbDSVmgyRmprPqm9kUx1Rqa6WIZLL6g09cEISYZZLLP1OhlzZ1Gl+2HJhBOZiMtAZ+V1AL5MNVk9JzLVsUwVZapV6ADENckwpAP4MJcdGNA7P68qlUr39hiWlaaRYJv1ynmlUqj9wQMFLWGQrfOL2jnuwzhjpudWGWoHwHD3bClocsXDgCTlPu9xQpasaOZnMBP3J5OP8/l7OM2M+TXmzdC6ZjJqcnEJvuLSNHh/BUsNUy0xIcKoLuJKHGVl4gjMyLyP/H0oYmoBNWKVUjwT7iQ7BIfcGgaizb1lWQTIkB/Gk8pwf2NlgliVzOyJnhnLsHkNyOc1XOdZuIg0D3IcSrD5UQk8xI5lMrOX3yplMoVfdaB2USerU82XETvk+K+Ln7D8+buEvVkdtmuXuP+zCV3zb/ItF79+4uE9MevLnDa94/jd9fpeZqUyR+Wzs7M/l3ewfLiakrnG42fNBi7/kKwZt2DQxFUBxxmvACn3pzORqZOCWO8DrFYsQ1L4SzIWVk6licyzDGBhoikmxjKkqsIxJgzFw6jKvJTOPJE5ozJUJnyZiF4z1XEHgHMAM1mzJ5OcyEittUamWITG1MpF/LlPyRyfFYvFzyADn6PM5RFuVepHULDYvU+gTNGbA4Byk96sVSfdXoF8/Hm1MoeFbberHu7B6rAbU8YyRrcLyYHRqUB23e3COHOIW0anUOkqpW6HTeQLeEDpQLmu0jVGMpLRLHQP1S5WqHYPO6uUiWcMQDEIihIfpzOzcy2Y30xxzwYUGOVmfm0npNrMSnOzSZYrxSVpIjNK+v8+0cS830v+pVGFK4vMdPKM2xrcz0xuVP6CxPjH8ix9XpXM6KdIVlpcO/kEyK8Cv/MEI61NgrNaGePUR4F/rRPpU1t/JUJO19ufpPjpNMpKZQo1krF7eftlKw4yljCFDl+zG8Jkw9/xv8GyLJBp+bcAXr0rzpq9FL5WRuotiIzfSEuHRurQQFjourenC218TwP38QNBaOt4cCKHMseNh3L5AW4BHs7KR+u7BUiej2XafbHn2K5guYw47AuCmxCHOUtmEnbvh8s4DsMMGdeyEkNwdIeP1pTMKANIrimdqU7SGV/G6jP93lAGF9u1wcYeynbfkoeyaQsgk5Pt4aCH7wW5bSgTKBOBRHMiY9vQUpu5uXF4WQANV9dBaGDn+ozTFmTbabdte2Bb7YMNkBkMGLk9YPSbR1G2eq4MagdMYuhCJBwLZB7bj1Bm2GsfBJ9mkZLpOUO57TKDA5vvC/LAZeQbeej2cjcoo6OMjNGTbw6YgexEWqZnP+YGri7AFWP3wc22bcdyBznoxfpwhunuwBHAwZEHApx6w4jIXFexA6hNy2Bnqzu6nstB+5xHXMIKzi1yQMg5/sIBNVjrOcfxR5wpGai3Wl2tTHzv923httC8uGwWCoVb7Jp1HEhGo+ASYFlyzeAwBDIXzVih0NxpNi+g2pXOm8Uz2syrSdoniEeODIOQnyyJP8pCeeuTFvCu09rmmiXIEk/++bi9vf1x+2C5dPlgmxT/54SklqNqM1NT6CHLMAsmzqdkFt2/jD6cyMyrMGSZbDb79HyY4plM4CN+85nM/BpZ8spzKPB8PtbZm0/6C7ZueyxjGrURzeZo67dhjmWQj1925tcY68TyockY+6kPqbl8/TIbGbN03Ch7/KmPto5KZnYmMl++prbm17mup81bX59Gxp8jm0wCkolBU5yNzNc1PW1eRubj8jIf1yizXGQ2R2b/Q2r+ewCvOs22v3zdmldhmNcMw+fTsfQCXheZnZ35Ncb28qHJMOQ9gHk8HWeWkyEZQDBxjgnvF2vwtTwvA9A0nAacpCBky5P5295skgFgRpaJZ8bzi5lV3QIYJZwSLgGKUvKnhl8bGa/pJawRn5orWO0qE83M3iUO55cXuKj/9h5pvCUycAtwdVm7/HXh5Qkrf3Refigf1e7I+K5Kb42MdHrcOIOqmkdQbXnlj87hjjDp32med95+mp3Wy3jvehiFOYA3dwBRe0D71shQmTfBxZc+zfBhbHVWpopPoKNymjEiu4SM6WPUrrrdCnlns9n0NgoFY/Tpi5GRMpwohvjrAMZO62WZ7+MEbm+cYz3P6WLfgyMz9VJDXEmHlmcyDBuL+c+01FoXKDSvyKr1RGYpvs+MM4ZX1e1VBZaHI5lYLLQ/U5HtjGTipZlXAePxt8pAw71kxph6ExBk0p1wXp/F+QyQCc5v/ayZsKyMV3qcNWtP1gBEJp0PRYZhITCxjjGX1vd/Cf8tJ/OfV/p7a36N+B+Gc6IlWunlWvl3vFRpuhXC1BmvheKyBCH81Q1zTSqA+e4y4Zxky5BuvbfM/dpcwOb+nWXWp4I27+uSXzTFFDKQCrXe9a+8xRbOZYZLKpXqvOuUU2d//kx9+Oy/s8zOWum861Cz+NdcwydKfzCEQqFQKBQKhUKhUCgUCoVCoVAoFAqFQqFQKBQKhUKJHv8DwILNCUP+XqUAAAAASUVORK5CYII=";
      function tr(en, hi) {
        return currentLang() === "hi" ? hi : en;
      }
      function currentLang() {
        return localStorage.getItem(LANG_KEY) || "hi";
      }
      function setLang(lang) {
        localStorage.setItem(LANG_KEY, lang);
        translateUI(lang);
        const sel = document.getElementById("langSelect");
        const mobileSel = document.getElementById("mobileLangSelect");
        if (sel) sel.value = lang;
        if (mobileSel) mobileSel.value = lang;
        // re-render hospitals to update translated names/text
        try {
          if (allHospitals && allHospitals.length) {
            displayHospitals(getSorted(allHospitals));
          }
        } catch {}
      }
      function toggleLanguage() {
        const next = currentLang() === "en" ? "hi" : "en";
        setLang(next);
      }
      function translateUI(lang) {
        const t = (en, hi) => (lang === "hi" ? hi : en);
        const set = (id, en, hi) => {
          const el = document.getElementById(id);
          if (el) el.textContent = t(en, hi);
        };
        set(
          "tagline",
          "Professional Hospital & Emergency Care Finder",
          "व्यावसायिक अस्पताल और आपातकालीन देखभाल खोजक"
        );
        set(
          "searchTitle",
          "Find Healthcare Facilities Near You",
          "अपने आसपास स्वास्थ्य सुविधाएँ खोजें"
        );
        const searchInput = document.getElementById("searchInput");
        if (searchInput)
          searchInput.placeholder = t(
            "Search by hospital name or city",
            "अस्पताल का नाम या शहर से खोजें"
          );
        set("searchBtn", "Search", "खोजें");
        set("locBtn", "Search by Location", "स्थान से खोजें");
        const favOnlyLabel = document.querySelector(
          'label[title="Show only favorites"] span'
        );
        if (favOnlyLabel)
          favOnlyLabel.textContent = t(
            "Show favorites only",
            "केवल पसंदीदा दिखाएँ"
          );
        
        // Translate all buttons and labels
        const callAmbulanceBtn = document.querySelector('button[onclick="window.location.href=\'tel:108\'"');
        if (callAmbulanceBtn) callAmbulanceBtn.textContent = t("Call Ambulance", "एम्बुलेंस बुलाएं");
        
        const exportFavBtn = document.querySelector('button[onclick="exportFavoritesCsv()"]');
        if (exportFavBtn) exportFavBtn.textContent = t("Export favorites (CSV)", "पसंदीदा निर्यात करें (CSV)");
        
        const exportResultsBtn = document.querySelector('button[onclick="exportResultsPdf()"]');
        if (exportResultsBtn) exportResultsBtn.textContent = t("Export results (PDF)", "परिणाम निर्यात करें (PDF)");
        
        const resetBtn = document.querySelector('button[onclick="resetFilters()"]');
        if (resetBtn) resetBtn.textContent = t("Reset filters", "फ़िल्टर रीसेट करें");
        const sortSelect = document.getElementById("sortSelect");
        if (sortSelect && sortSelect.options.length >= 3) {
          sortSelect.options[0].text = t(
            "Sort by Distance",
            "दूरी के अनुसार क्रमबद्ध करें"
          );
          sortSelect.options[1].text = t(
            "Sort by Rating",
            "रेटिंग के अनुसार क्रमबद्ध करें"
          );
          sortSelect.options[2].text = t(
            "Sort by Available Beds",
            "खाली बिस्तरों के अनुसार क्रमबद्ध करें"
          );
        }
        set("aboutTitle", "About HosiTat", "हॉसिटैट के बारे में");
        set(
          "aboutText",
          "An open, user-first interface to discover hospitals and emergency care near you with transparent stats and navigation.",
          "अस्पतालों और आपातकालीन देखभाल को खोजने के लिए पारदर्शी आँकड़ों और नेविगेशन के साथ एक खुला, उपयोगकर्ता-प्रथम इंटरफ़ेस।"
        );
        set("teamTitle", "Made by", "निर्माता");
        set("contactTitle", "Contact", "संपर्क");
        const loadingText = document.querySelector(".loading-text");
        if (loadingText)
          loadingText.textContent = t("Searching...", "खोज जारी है...");
        const sel = document.getElementById("langSelect");
        const mobileSel = document.getElementById("mobileLangSelect");
        if (sel) sel.value = lang;
        if (mobileSel) mobileSel.value = lang;
        const afs = document.getElementById("advancedFiltersSummary");
        if (afs) afs.textContent = t("Advanced filters", "उन्नत फ़िल्टर");
        const sortLabel = document.getElementById("sortLabel");
        if (sortLabel) sortLabel.textContent = t("Sort", "क्रमबद्ध करें");
        const city = document.getElementById("filterCity");
        if (city) city.placeholder = t("City", "शहर");
        const state = document.getElementById("filterState");
        if (state) state.placeholder = t("State", "राज्य");
        const ins = document.getElementById("filterInsurance");
        if (ins)
          ins.placeholder = t(
            "Insurance accepted (e.g., PM-JAY)",
            "बीमा (जैसे, PM-JAY)"
          );
        const distText = document.getElementById("distanceTextLabel");
        if (distText)
          distText.childNodes[0].nodeValue = t(
            "Max Distance (km): ",
            "अधिकतम दूरी (किमी): "
          );
        const ratingText = document.getElementById("ratingTextLabel");
        if (ratingText)
          ratingText.childNodes[0].nodeValue = t(
            "Min Rating: ",
            "न्यूनतम रेटिंग: "
          );
        const bedsText = document.getElementById("bedsTextLabel");
        if (bedsText)
          bedsText.childNodes[0].nodeValue = t(
            "Min Available Beds: ",
            "न्यूनतम खाली बिस्तर: "
          );
        set("filterTypeLabel", "Hospital Type:", "अस्पताल प्रकार:");
        set("typeAllBtn", "All Hospitals", "सभी अस्पताल");
        set("typeEmergencyBtn", "Emergency", "आपातकालीन");
        set("typeGeneralBtn", "General", "सामान्य");
        set("filterSpecLabel", "Specialization:", "विशेषज्ञता:");
        set("specAllBtn", "All Specialties", "सभी विशेषज्ञताएँ");
        set("specCardiologyBtn", "Cardiology", "हृदय रोग");
        set("specNeurologyBtn", "Neurology", "तंत्रिका विज्ञान");
        set("specRadiologyBtn", "Radiology", "रेडियोलॉजी");
        set("specOrthopedicsBtn", "Orthopedics", "अस्थि रोग");
        set("specPediatricsBtn", "Pediatrics", "शिशु रोग");
        set("specOncologyBtn", "Oncology", "कैंसर विज्ञान");
        set("specSurgeryBtn", "Surgery", "शल्य चिकित्सा");
        
        // Translate no results message
        set("noResultsTitle", "No hospitals found matching your criteria", "आपके मानदंडों से मेल खाने वाले कोई अस्पताल नहीं मिले");
        set("noResultsText", "Try adjusting your filters or search in a different area.", "अपने फ़िल्टर को समायोजित करने या किसी अन्य क्षेत्र में खोजने का प्रयास करें।");
        
        // Update facility filter labels
        document.querySelectorAll('.checkbox span').forEach(span => {
          const text = span.textContent.trim();
          if (text === '24/7 Emergency' || text === '24/7 आपातकाल') span.textContent = t('24/7 Emergency', '24/7 आपातकाल');
          else if (text === 'ICU' || text === 'आईसीयू') span.textContent = t('ICU', 'आईसीयू');
          else if (text === 'Blood Bank' || text === 'रक्त बैंक') span.textContent = t('Blood Bank', 'रक्त बैंक');
          else if (text === 'Ambulance' || text === 'एम्बुलेंस') span.textContent = t('Ambulance', 'एम्बुलेंस');
          else if (text === 'Radiology' || text === 'रेडियोलॉजी') span.textContent = t('Radiology', 'रेडियोलॉजी');
        });
        
        // Update filter section labels
        document.querySelectorAll('.filter-label').forEach(label => {
          const text = label.textContent.trim();
          if (text === 'City' || text === 'शहर') label.textContent = t('City', 'शहर');
          else if (text === 'State' || text === 'राज्य') label.textContent = t('State', 'राज्य');
          else if (text === 'Insurance' || text === 'बीमा') label.textContent = t('Insurance', 'बीमा');
          else if (text === 'Facilities' || text === 'सुविधाएं') label.textContent = t('Facilities', 'सुविधाएं');
        });
        
        // Translate hospital card text
        document.querySelectorAll('.info-item').forEach(item => {
          const span = item.querySelector('span:first-child');
          if (span) {
            const text = span.textContent.trim();
            if (text === 'Distance') span.textContent = t('Distance', 'दूरी');
            else if (text === 'Available Beds') span.textContent = t('Available Beds', 'खाली बिस्तर');
            else if (text === 'Wait Time') span.textContent = t('Wait Time', 'प्रतीक्षा समय');
            else if (text === 'Rating') span.textContent = t('Rating', 'रेटिंग');
          }
        });
        
        // Translate button text in hospital cards
        document.querySelectorAll('.route-btn').forEach(btn => {
          btn.textContent = t('Get Directions', 'मार्ग निर्देश');
        });
        
        document.querySelectorAll('.favorite-btn').forEach(btn => {
          if (btn.classList.contains('active')) {
            btn.textContent = t('Favorited', 'पसंद किया');
          } else {
            btn.textContent = t('Favorite', 'पसंदीदा');
          }
        });
        
        // Translate stats section
        document.querySelectorAll('.stat-label').forEach(label => {
          const text = label.textContent.trim();
          if (text === 'Total Found') label.textContent = t('Total Found', 'कुल मिले');
          else if (text === 'Emergency') label.textContent = t('Emergency', 'आपातकाल');
          else if (text === 'Avg Distance (km)') label.textContent = t('Avg Distance (km)', 'औसत दूरी (किमी)');
          else if (text === 'Available Beds') label.textContent = t('Available Beds', 'खाली बिस्तर');
        });
        
        // Translate compare and modal text
        document.querySelectorAll('.select-compare').forEach(btn => {
          if (btn.textContent.trim() === 'Selected') {
            btn.textContent = t('Selected', 'चयनित');
          } else {
            btn.textContent = t('Compare', 'तुलना');
          }
        });
      }

      // THEME
      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        const theme = saved || "light";
        document.documentElement.setAttribute("data-theme", theme);
        const toggle = document.getElementById("themeToggle");
        if (toggle) toggle.checked = theme === "dark";
      }
      function toggleTheme(checkbox) {
        const theme = checkbox.checked ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(THEME_KEY, theme);
      }

      // DATE
      document.getElementById("year").textContent = new Date().getFullYear();

      // Images (your Unsplash list, deterministic)
      function getHospitalImage(hospitalName) {
        const hospitalImages = [
          "https://images.unsplash.com/photo-1551190822-a9333d879b1f?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1586773860418-d37222d8fce3?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1582750433449-648ed127bb54?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1581595220892-b0739db3ba8c?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1563213126-a4273aed2016?w=900&h=600&fit=crop",
          "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=900&h=600&fit=crop",
        ];
        const hash = hospitalName
          .split("")
          .reduce((a, b) => (a << 5) - a + b.charCodeAt(0), 0);
        return hospitalImages[Math.abs(hash) % hospitalImages.length];
      }

      // Utilities
      function generateSpecialties(isEmergency) {
        const allSpecialties = [
          "cardiology",
          "neurology",
          "radiology",
          "orthopedics",
          "pediatrics",
          "oncology",
          "surgery",
          "dermatology",
          "psychiatry",
          "gynecology",
        ];
        const emergencySpecialties = [
          "emergency",
          "trauma",
          "surgery",
          "cardiology",
          "neurology",
        ];
        if (isEmergency)
          return emergencySpecialties.slice(
            0,
            3 + Math.floor(Math.random() * 2)
          );
        const count = 2 + Math.floor(Math.random() * 4);
        return allSpecialties.sort(() => 0.5 - Math.random()).slice(0, count);
      }
      function getDistance(lat1, lon1, lat2, lon2) {
        // Validate input coordinates
        if (!lat1 || !lon1 || !lat2 || !lon2 || 
            isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
          return 0;
        }
        
        // Earth's radius in kilometers
        const R = 6371.0088;
        
        // Convert degrees to radians
        const toRad = (deg) => deg * (Math.PI / 180);
        
        const lat1Rad = toRad(parseFloat(lat1));
        const lon1Rad = toRad(parseFloat(lon1));
        const lat2Rad = toRad(parseFloat(lat2));
        const lon2Rad = toRad(parseFloat(lon2));
        
        // Haversine formula
        const dLat = lat2Rad - lat1Rad;
        const dLon = lon2Rad - lon1Rad;
        
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        
        // Calculate distance and round to 2 decimal places
        const distance = R * c;
        return Math.round(distance * 100) / 100;
      }
      function isEmergencyHospital(tags) {
        if (!tags) return false;
        const emergencyKeywords = [
          "emergency",
          "trauma",
          "critical",
          "urgent",
          "emergency_ward",
          "emergency_room",
          "er",
          "a&e",
          "casualty",
        ];
        const checkFields = [
          tags.emergency,
          tags["healthcare:speciality"],
          tags.amenity,
          tags.name?.toLowerCase(),
          tags["emergency_service"],
          tags.medical_system,
        ];
        return (
          checkFields.some(
            (field) =>
              field &&
              emergencyKeywords.some((keyword) =>
                String(field).toLowerCase().includes(keyword)
              )
          ) ||
          tags.emergency === "yes" ||
          tags["emergency_service"] === "yes"
        );
      }
      function generateHospitalDetails(isEmergency, distance, specialties) {
        const baseBeds = isEmergency ? 200 : 100;
        const totalBeds = baseBeds + Math.floor(Math.random() * 300);
        const occupancyRate = 0.6 + Math.random() * 0.35;
        const availableBeds = Math.floor(totalBeds * (1 - occupancyRate));
        return {
          totalBeds,
          availableBeds,
          occupiedBeds: totalBeds - availableBeds,
          waitTime: isEmergency
            ? 5 + Math.floor(Math.random() * 15)
            : 20 + Math.floor(Math.random() * 40),
          rating: (3.5 + Math.random() * 1.5).toFixed(1),
          contact: `+91-${Math.floor(Math.random() * 900000000 + 100000000)}`,
          email: `info@${Math.random().toString(36).substr(2, 8)}hospital.com`,
          established: 1980 + Math.floor(Math.random() * 40),
          staff: 50 + Math.floor(Math.random() * 500),
          specialties,
          facilities: isEmergency
            ? [
                "24/7 Emergency",
                "ICU",
                "Ambulance",
                "Blood Bank",
                "Pharmacy",
                "Radiology",
              ]
            : ["OPD", "Pharmacy", "Laboratory", "Radiology", "Physiotherapy"],
          insurance: [
            "Health Insurance",
            "PM-JAY",
            "Mediclaim",
            "Cashless Treatment",
            "Government Schemes",
          ],
          visitingHours: isEmergency ? "24 Hours" : "9:00 AM - 8:00 PM",
          address: tr("Address unavailable", "पता उपलब्ध नहीं"),
        };
      }

      // Loader
      function showLoader() {
        document.getElementById("loading").style.display = "flex";
        const lb = document.getElementById("locBtn");
        if (lb) lb.disabled = true;
      }
      function hideLoader() {
        document.getElementById("loading").style.display = "none";
        const lb = document.getElementById("locBtn");
        if (lb) lb.disabled = false;
      }

      // Filter helpers
      function filterByType(type, btnEl) {
        currentTypeFilter = type;
        updateActiveButton(".filter-group:first-child .filter-btn", btnEl);
        applyFilters();
      }
      function filterBySpecialty(specialty, btnEl) {
        currentSpecialtyFilter = specialty;
        updateActiveButton(".filter-group:last-child .filter-btn", btnEl);
        applyFilters();
      }
      function updateActiveButton(selector, activeBtn) {
        document
          .querySelectorAll(selector)
          .forEach((btn) => btn.classList.remove("active"));
        activeBtn.classList.add("active");
      }
      function onSearchInput() {
        currentSearch = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        if (currentSearch) addToHistory(currentSearch);
        applyFilters();
      }
      function resetFilters() {
        currentTypeFilter = "all";
        currentSpecialtyFilter = "all";
        currentSearch = "";
        document.getElementById("searchInput").value = "";
        document.getElementById("favoritesOnly").checked = false;
        document.getElementById("sortSelect").value = "distance";
        document.getElementById("filterCity").value = "";
        document.getElementById("filterState").value = "";
        document.getElementById("filterInsurance").value = "";
        [
          "filter247",
          "filterICU",
          "filterBlood",
          "filterAmbulance",
          "filterRadiology",
        ].forEach((id) => (document.getElementById(id).checked = false));
        document.getElementById("distanceRange").value = 20;
        updateDistanceLabel(20);
        document.getElementById("minRating").value = 0;
        updateRatingLabel(0);
        document.getElementById("minBeds").value = 0;
        updateBedsLabel(0);
        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelector(".filter-group:first-child .filter-btn")
          ?.classList.add("active");
        document
          .querySelector(".filter-group:last-child .filter-btn")
          ?.classList.add("active");
        applyFilters();
      }
      function getSorted(hospitals) {
        const sortValue = document.getElementById("sortSelect").value;
        const list = hospitals.slice();
        if (sortValue === "distance")
          list.sort((a, b) => a.distance - b.distance);
        else if (sortValue === "rating")
          list.sort(
            (a, b) =>
              parseFloat(b.details.rating) - parseFloat(a.details.rating)
          );
        else if (sortValue === "beds")
          list.sort(
            (a, b) => b.details.availableBeds - a.details.availableBeds
          );
        return list;
      }
      function updateDistanceLabel(v) {
        document.getElementById("distanceLabel").textContent = `0–${v}`;
      }
      function updateRatingLabel(v) {
        document.getElementById("ratingLabel").textContent = `${v}`;
      }
      function updateBedsLabel(v) {
        document.getElementById("bedsLabel").textContent = `${v}`;
      }

      function applyFilters() {
        let filteredHospitals = allHospitals;

        if (currentTypeFilter === "emergency")
          filteredHospitals = filteredHospitals.filter((h) => h.isEmergency);
        else if (currentTypeFilter === "general")
          filteredHospitals = filteredHospitals.filter((h) => !h.isEmergency);

        if (currentSpecialtyFilter !== "all")
          filteredHospitals = filteredHospitals.filter((h) =>
            h.details.specialties.includes(currentSpecialtyFilter)
          );
        if (currentSearch)
          filteredHospitals = filteredHospitals.filter((h) =>
            h.name.toLowerCase().includes(currentSearch)
          );

        const city = document
          .getElementById("filterCity")
          .value.trim()
          .toLowerCase();
        const state = document
          .getElementById("filterState")
          .value.trim()
          .toLowerCase();
        const insurance = document
          .getElementById("filterInsurance")
          .value.trim()
          .toLowerCase();
        const only247 = document.getElementById("filter247").checked;
        const needICU = document.getElementById("filterICU").checked;
        const needBlood = document.getElementById("filterBlood").checked;
        const needAmbulance =
          document.getElementById("filterAmbulance").checked;
        const needRadiology =
          document.getElementById("filterRadiology").checked;

        const maxDistance = Number(
          document.getElementById("distanceRange").value
        );
        const minRating = Number(document.getElementById("minRating").value);
        const minBeds = Number(document.getElementById("minBeds").value);

        filteredHospitals = filteredHospitals.filter((h) => {
          if (userLat !== null && userLon !== null && h.distance > maxDistance)
            return false;
          if (parseFloat(h.details.rating) < minRating) return false;
          if (h.details.availableBeds < minBeds) return false;
          if (only247 && !h.isEmergency) return false;

          if (needICU && !h.details.facilities.includes("ICU")) return false;
          if (needBlood && !h.details.facilities.includes("Blood Bank"))
            return false;
          if (needAmbulance && !h.details.facilities.includes("Ambulance"))
            return false;
          if (needRadiology && !h.details.facilities.includes("Radiology"))
            return false;

          if (
            insurance &&
            !h.details.insurance.join(" ").toLowerCase().includes(insurance)
          )
            return false;

          const t = h.tags || {};
          if (
            city &&
            !(
              (t["addr:city"] || "").toLowerCase().includes(city) ||
              h.name.toLowerCase().includes(city)
            )
          )
            return false;
          if (state && !(t["addr:state"] || "").toLowerCase().includes(state))
            return false;

          return true;
        });

        const favOnly = document.getElementById("favoritesOnly").checked;
        if (favOnly)
          filteredHospitals = filteredHospitals.filter((h) =>
            favoriteNames.has(h.name)
          );

        filteredHospitals = getSorted(filteredHospitals);
        displayHospitals(filteredHospitals);
        updateStats(filteredHospitals);

        // Show/hide appropriate content based on results
        const landing = document.getElementById("landing");
        const noResultsSection = document.getElementById("noResultsSection");
        
        if (filteredHospitals.length > 0) {
          landing.style.display = "none";
          noResultsSection.style.display = "none";
        } else {
          landing.style.display = "none";
          noResultsSection.style.display = "block";
        }
        // cache for PWA offline
        try {
          localStorage.setItem(
            "hositat_last_results",
            JSON.stringify(filteredHospitals)
          );
        } catch {}
      }

      function showAdvancedFilters() {
        const stats = document.getElementById("statsSection");
        const adv = document.getElementById("advancedFilters");
        if (stats && adv && adv.parentElement !== stats.parentElement) {
          // ensure it's placed after stats section
          stats.insertAdjacentElement("afterend", adv);
        } else if (stats && adv) {
          stats.insertAdjacentElement("afterend", adv);
        }
        if (adv) adv.style.display = "block";
        setAdvancedFiltersOpenByViewport();
      }

      // Make Advanced Filters collapsed on mobile, expanded on desktop
      function setAdvancedFiltersOpenByViewport() {
        try {
          const det = document.querySelector("#advancedFilters details");
          if (!det) return;
          if (window.innerWidth <= 600) det.removeAttribute("open");
          else det.setAttribute("open", "");
        } catch {}
      }
      (function listenViewportForFilters() {
        let resizeTimer = null;
        window.addEventListener("resize", () => {
          if (resizeTimer) clearTimeout(resizeTimer);
          resizeTimer = setTimeout(
            () => setAdvancedFiltersOpenByViewport(),
            200
          );
        });
      })();

      // Voice search
      function voiceSearch() {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("Web Speech API not supported in this browser.");
          return;
        }
        const rec = new SpeechRecognition();
        rec.lang = "en-IN";
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.onresult = (e) => {
          const text = e.results[0][0].transcript;
          document.getElementById("searchInput").value = text;
          onSearchInput();
        };
        rec.onerror = () => alert("Voice recognition error. Please try again.");
        rec.start();
      }

      // Favorites
      function loadFavorites() {
        try {
          const raw = localStorage.getItem(FAVORITES_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }
      function saveFavorites() {
        try {
          localStorage.setItem(
            FAVORITES_KEY,
            JSON.stringify(Array.from(favoriteNames))
          );
        } catch {}
      }
      function toggleFavorite(e, hospitalName) {
        e.stopPropagation();
        if (favoriteNames.has(hospitalName)) favoriteNames.delete(hospitalName);
        else favoriteNames.add(hospitalName);
        saveFavorites();
        applyFilters();
      }

      // Search history
      function addToHistory(q) {
        try {
          const raw = localStorage.getItem(HISTORY_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          if (!arr.includes(q)) {
            arr.unshift(q);
            if (arr.length > 8) arr.pop();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
            renderHistory();
          }
        } catch {}
      }
      function renderHistory() {
        const wrap = document.getElementById("historyChips");
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        wrap.innerHTML = "";
        arr.forEach((q) => {
          const b = document.createElement("button");
          b.className = "btn";
          b.textContent = q;
          b.onclick = () => {
            document.getElementById("searchInput").value = q;
            onSearchInput();
          };
          wrap.appendChild(b);
        });
      }

      // Export
      function exportFavoritesCsv() {
        const favs = allHospitals.filter((h) => favoriteNames.has(h.name));
        if (!favs.length) {
          alert("No favorites to export.");
          return;
        }
        const rows = [
          [
            "Name",
            "Distance(km)",
            "Type",
            "AvailableBeds",
            "Rating",
            "Phone",
            "Email",
            "Latitude",
            "Longitude",
          ],
        ];
        favs.forEach((h) =>
          rows.push([
            h.name,
            h.distance,
            h.isEmergency ? "Emergency" : "General",
            h.details.availableBeds,
            h.details.rating,
            h.details.contact,
            h.details.email,
            h.lat,
            h.lon,
          ])
        );
        const csv = rows
          .map((r) =>
            r.map((v) => `"${String(v).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "hositat_favorites.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      async function exportResultsPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("HosiTat - Search Results", 14, 15);
        doc.setFontSize(10);
        let y = 24;
        const results = document.querySelectorAll(
          ".hospital .hospital-content"
        );
        if (!results.length) {
          doc.text("No results to export.", 14, y);
          doc.save("hositat_results.pdf");
          return;
        }
        results.forEach((el, idx) => {
          const name =
            el.querySelector(".hospital-name span")?.textContent || "Hospital";
          const items = el.querySelectorAll(".info-item");
          const dist =
            items[0]?.querySelector("span:last-child")?.textContent || "";
          const beds =
            items[1]?.querySelector("span:last-child")?.textContent || "";
          const wait =
            items[2]?.querySelector("span:last-child")?.textContent || "";
          const rating =
            items[3]?.querySelector("span:last-child")?.textContent || "";
          const line = `${idx + 1}. ${name} | ${dist} | ${tr(
            "Beds",
            "बिस्तर"
          )}: ${beds} | ${tr("Wait", "प्रतीक्षा")}: ${wait} | ${tr(
            "Rating",
            "रेटिंग"
          )}: ${rating}`;
          if (y > 280) {
            doc.addPage();
            y = 15;
          }
          doc.text(line, 14, y);
          y += 6;
        });
        doc.save("hositat_results.pdf");
      }

      // Render
      function renderSkeletons(n = 6) {
        const container = document.getElementById("hospital-list");
        container.innerHTML = "";
        for (let i = 0; i < n; i++) {
          const d = document.createElement("div");
          d.className = "skeleton";
          const sh = document.createElement("div");
          sh.className = "shimmer";
          d.appendChild(sh);
          container.appendChild(d);
        }
      }
      function displayHospitals(hospitals) {
        const container = document.getElementById("hospital-list");
        container.innerHTML = "";
        if (!hospitals || hospitals.length === 0) {
          const noResultsSection = document.getElementById("noResultsSection");
          if (noResultsSection) {
            noResultsSection.style.display = "block";
          } else {
            container.innerHTML = `
              <div style="grid-column: 1/-1; text-align: center; padding: 36px; color: var(--muted); background: var(--surface); border:1px solid var(--border); border-radius: 10px;">
                <h3 style="margin-bottom:6px;">No hospitals found matching your criteria</h3>
                <p>Try adjusting your filters or search in a different area.</p>
              </div>
            `;
          }
          return;
        }
        hospitals.forEach((hospital, idx) => {
          const div = document.createElement("div");
          div.className = hospital.isEmergency
            ? "hospital emergency"
            : "hospital";
          div.style.animationDelay = idx * 60 + "ms";
          div.classList.add("animate");
          div.setAttribute("role", "article");
          div.onclick = (e) => {
            if (
              e.target &&
              (e.target.classList.contains("favorite-btn") ||
                e.target.classList.contains("select-compare") ||
                e.target.classList.contains("route-btn"))
            )
              return;
            openHospitalModal(hospital);
          };

          const bedStatus =
            hospital.details.availableBeds > 50
              ? "status-good"
              : hospital.details.availableBeds > 20
              ? "status-moderate"
              : "status-critical";
          const waitStatus =
            hospital.details.waitTime <= 15
              ? "status-good"
              : hospital.details.waitTime <= 30
              ? "status-moderate"
              : "status-critical";
          const isFav = favoriteNames.has(hospital.name);
          const checked = compareSet.has(hospital.name) ? "checked" : "";

          div.innerHTML = `
            <button class="select-compare" onclick="toggleCompare(event, '${hospital.name.replace(
              /'/g,
              "\\'"
            )}')" aria-pressed="${checked ? "true" : "false"}">${
            checked ? tr("Selected", "चयनित") : tr("Compare", "तुलना")
          }</button>
            <img class="hospital-image lazyload" src="${FALLBACK_IMAGE}" data-src="${
            hospital.image
          }" alt="${translateHospitalName(
            hospital.name
          )}" onerror="this.src='${FALLBACK_IMAGE}'; this.onerror=null;">
            <div class="hospital-content">
              <div class="hospital-name">
                <span>${translateHospitalName(hospital.name)}</span>
                <div style="display:flex; gap:8px;">
                  <button class="btn route-btn" onclick="event.stopPropagation(); routeToHospital(${
                    hospital.lat
                  }, ${hospital.lon}, '${hospital.name.replace(
            /'/g,
            "\\'"
          )}')">${tr("Get Directions", "मार्ग निर्देश")}</button>
                  <button class="favorite-btn ${
                    isFav ? "active" : ""
                  }" onclick="toggleFavorite(event, '${hospital.name.replace(
            /'/g,
            "\\'"
          )}')">${
            isFav ? tr("Favorited", "पसंद किया") : tr("Favorite", "पसंदीदा")
          }</button>
                </div>
              </div>
              <div class="hospital-specialties">
                ${hospital.details.specialties
                  .slice(0, 3)
                  .map((spec) => `<span class="specialty-tag">${spec}</span>`)
                  .join("")}
                ${
                  hospital.details.specialties.length > 3
                    ? '<span class="specialty-tag">+more</span>'
                    : ""
                }
              </div>
              <div class="hospital-info">
                <div class="info-item"><span>${tr(
                  "Distance",
                  "दूरी"
                )}</span><span>${hospital.distance} km</span></div>
                <div class="info-item"><span>${tr(
                  "Available Beds",
                  "खाली बिस्तर"
                )}</span><span class="${bedStatus}">${
            hospital.details.availableBeds
          }</span></div>
                <div class="info-item"><span>${tr(
                  "Wait Time",
                  "प्रतीक्षा समय"
                )}</span><span class="${waitStatus}">${
            hospital.details.waitTime
          } min</span></div>
                <div class="info-item"><span>${tr(
                  "Rating",
                  "रेटिंग"
                )}</span><span>${
                  hospital.details.rating
                }/5</span></div>
              </div>
            </div>
          `;
          container.appendChild(div);
          // removed mini-map preview
        });
      }

      // Stats + Trends
      let prevStats = null;
      function updateStats(hospitals) {
        const totalEl = document.getElementById("totalHospitals");
        const emergEl = document.getElementById("emergencyCount");
        const distEl = document.getElementById("averageDistance");
        const bedsEl = document.getElementById("availableBeds");

        const total = hospitals.length;
        const emerg = hospitals.filter((h) => h.isEmergency).length;
        const avgDist = hospitals.length
          ? hospitals.reduce((s, h) => s + h.distance, 0) / hospitals.length
          : 0;
        const totalBeds = hospitals.reduce(
          (s, h) => s + h.details.availableBeds,
          0
        );

        totalEl.textContent = total;
        emergEl.textContent = emerg;
        distEl.textContent = avgDist.toFixed(1);
        bedsEl.textContent = totalBeds;

        const trendTotal = document.getElementById("trendTotal");
        const trendEmergency = document.getElementById("trendEmergency");
        const trendDistance = document.getElementById("trendDistance");
        const trendBeds = document.getElementById("trendBeds");

        if (prevStats) {
          trendTotal.textContent = trendArrow(total - prevStats.total);
          trendEmergency.textContent = trendArrow(emerg - prevStats.emerg);
          trendDistance.textContent = trendArrow(
            parseFloat(avgDist.toFixed(1)) - prevStats.avgDist,
            true
          );
          trendBeds.textContent = trendArrow(totalBeds - prevStats.totalBeds);
        }
        prevStats = {
          total,
          emerg,
          avgDist: parseFloat(avgDist.toFixed(1)),
          totalBeds,
        };
      }
      function trendArrow(delta, inverse = false) {
        if (delta === 0) return "—";
        const up = delta > 0;
        if (inverse) return up ? "↑ (worse)" : "↓ (better)";
        return up ? "↑" : "↓";
      }

      // Main map + layers
      // Removed homepage map usage

      // POI Layers via Overpass
      async function togglePoiLayer(kind) {
        if (!mainMap || !userLat || !userLon) {
          alert(
            'Center on your location first by clicking "Find Hospitals Near Me".'
          );
          return;
        }
        if (poiLayers[kind]) {
          if (mainMap.hasLayer(poiLayers[kind]))
            mainMap.removeLayer(poiLayers[kind]);
          else mainMap.addLayer(poiLayers[kind]);
          return;
        }
        let query = "";
        if (kind === "pharmacy")
          query = `node["amenity"="pharmacy"](around:5000,${userLat},${userLon});`;
        if (kind === "clinic")
          query = `node["amenity"="clinic"](around:5000,${userLat},${userLon});`;
        if (kind === "atm")
          query = `node["amenity"="atm"](around:5000,${userLat},${userLon});`;

        const overpassQuery = `[out:json][timeout:25]; (${query}); out center;`;
        try {
          const res = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: overpassQuery,
          });
          const data = await res.json();
          const group = L.layerGroup();
          (data.elements || []).forEach((e) => {
            if (!e.lat || !e.lon) return;
            const nm = e.tags?.name || kind.toUpperCase();
            L.marker([e.lat, e.lon]).addTo(group).bindPopup(`<b>${nm}</b>`);
          });
          poiLayers[kind] = group;
          mainMap.addLayer(group);
        } catch {
          alert("Failed to load POIs.");
        }
      }

      // Routing on main map quickly from card button
      function routeToHospital(lat, lon, name) {
        getDirections(lat, lon);
      }

      // Modal with routing + charts + reviews (starability)
      let routeControlInModal = null,
        routeMapInstance = null,
        bedChart = null,
        waitChart = null;

      function openHospitalModal(hospital) {
        document.getElementById("modalHospitalName").textContent =
          hospital.name;
        const modalContent = document.getElementById("modalContent");

        modalContent.innerHTML = `
          <div class="hospital-detail-grid">
            <div class="detail-section">
              <h3>${tr("Specializations", "विशेषज्ञताएँ")}</h3>
              <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                ${hospital.details.specialties
                  .map(
                    (spec) =>
                      `<span class="specialty-tag" style="background: var(--primary); color: #fff; border-color: var(--primary);">${spec}</span>`
                  )
                  .join("")}
              </div>
              <div class="detail-row"><span>${tr("Insurance", "बीमा")}</span><span>${hospital.details.insurance.join(
                ", "
              )}</span></div>
              <div class="detail-row"><span>${tr("Address", "पता")}</span><span>${
                hospital.details.address || tr("Not available", "उपलब्ध नहीं")
              }</span></div>
              <div id="map"></div>
            </div>
  
            <div class="detail-section">
              <h3>${tr("Contact & Actions", "संपर्क और क्रियाएँ")}</h3>
              <div class="detail-row"><span>${tr("Phone", "फोन")}</span><span style="color:#007bff;">${
                hospital.details.contact
              }</span></div>
              <div class="detail-row"><span>${tr("Email", "ईमेल")}</span><span style="color:#007bff;">${
                hospital.details.email
              }</span></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                <button class="btn" onclick="openExternalMap(${hospital.lat}, ${
          hospital.lon
        }, '${hospital.name.replace(/'/g, "\\'")}')">${tr("Open Google Maps", "गूगल मैप्स खोलें")}</button>
                <button class="btn" onclick="openExternalOsm(${hospital.lat}, ${
          hospital.lon
        })">${tr("Open OSM", "OSM खोलें")}</button>
                <button class="btn" onclick="getDirections(${hospital.lat}, ${
          hospital.lon
        })">${tr("Get Directions", "मार्ग निर्देश")}</button>
                <button class="btn" onclick="callHospital('${
                  hospital.details.contact
                }')">${tr("Call Hospital", "अस्पताल को कॉल करें")}</button>
                <button class="btn" onclick="openBooking('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}')">${tr("Book Appointment", "अपॉइंटमेंट बुक करें")}</button>
              </div>
            </div>
  
            <div class="detail-section">
              <h3>${tr("Basic Information", "मूल जानकारी")}</h3>
              <div class="detail-row"><span>${tr("Type", "प्रकार")}</span><span>${
                hospital.isEmergency ? tr("Emergency Hospital", "आपातकालीन अस्पताल") : tr("General Hospital", "सामान्य अस्पताल")
              }</span></div>
              <div class="detail-row"><span>${tr("Established", "स्थापित")}</span><span>${
                hospital.details.established
              }</span></div>
              <div class="detail-row"><span>${tr("Distance", "दूरी")}</span><span>${
                hospital.distance
              } ${tr("km", "किमी")}</span></div>
              <div class="detail-row"><span>${tr("Rating", "रेटिंग")}</span><span>${
                hospital.details.rating
              } / 5.0</span></div>
              <div class="detail-row"><span>${tr("Staff Count", "स्टाफ संख्या")}</span><span>${
                hospital.details.staff
              }+ ${tr("professionals", "पेशेवर")}</span></div>
            </div>
  
            <div class="detail-section">
              <h3>${tr("Beds & Wait Time", "बिस्तर और प्रतीक्षा समय")}</h3>
              <div class="detail-row"><span>${tr("Total Beds", "कुल बिस्तर")}</span><span>${
                hospital.details.totalBeds
              }</span></div>
              <div class="detail-row"><span>${tr("Available", "उपलब्ध")}</span><span class="${
                hospital.details.availableBeds > 50
                  ? "status-good"
                  : hospital.details.availableBeds > 20
                  ? "status-moderate"
                  : "status-critical"
              }">${hospital.details.availableBeds}</span></div>
              <div class="detail-row"><span>${tr("Occupied", "कब्जे में")}</span><span>${
                hospital.details.occupiedBeds
              }</span></div>
              <div class="detail-row"><span>${tr("Current Wait", "वर्तमान प्रतीक्षा")}</span><span>${
                hospital.details.waitTime
              } ${tr("minutes", "मिनट")}</span></div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                <input id="crowdWait" class="search-input" type="number" min="0" placeholder="${tr("Submit wait time (min)", "प्रतीक्षा समय जमा करें (मिनट)")}" style="max-width:180px;"/>
                <button class="btn" onclick="submitWaitTime('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}')">${tr("Submit", "जमा करें")}</button>
                <button class="btn btn-ghost" onclick="simulateBedApi('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}')">${tr("Update via State API", "राज्य API के माध्यम से अपडेट करें")}</button>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <canvas id="bedPie"></canvas>
                <canvas id="waitBar"></canvas>
              </div>
            </div>
  
            <div class="detail-section">
              <h3>${tr("Nearby & Routing", "नज़दीकी व मार्ग")}</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin:0 0 8px 0;">
                <button class="btn" onclick="loadNearby('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}', ${hospital.lat}, ${
          hospital.lon
        }, 'pharmacy')">${tr("Pharmacies", "दवाखाने")}</button>
                <button class="btn" onclick="loadNearby('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}', ${hospital.lat}, ${
          hospital.lon
        }, 'clinic')">${tr("Clinics", "क्लिनिक")}</button>
                <button class="btn" onclick="loadNearby('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}', ${hospital.lat}, ${
          hospital.lon
        }, 'blood_bank')">${tr("Blood Banks", "रक्त बैंक")}</button>
                <button class="btn" onclick="loadNearby('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}', ${hospital.lat}, ${
          hospital.lon
        }, 'public_transport')">${tr("Public Transport", "सार्वजनिक परिवहन")}</button>
                <button class="btn btn-danger" onclick="startRoutingInModal(${
                  hospital.lat
                }, ${hospital.lon})">${tr("Get Directions (Route)", "मार्ग निर्देश (रूट)")}</button>
              </div>
              <div id="nearbyList" style="margin-bottom:8px; display:grid; gap:6px;"></div>
              <div id="routeMap"></div>
            </div>
  
            <div class="detail-section">
              <h3>${tr("User Reviews", "उपयोगकर्ता समीक्षा")}</h3>
              <div class="reviews" id="reviewsWrap"></div>
              <div class="review-form">
                <fieldset class="starability-basic" style="border:0;">
                  <input type="radio" id="rate5" name="rating" value="5" />
                  <label for="rate5" title="Amazing">5 stars</label>
                  <input type="radio" id="rate4" name="rating" value="4" />
                  <label for="rate4" title="Very good">4 stars</label>
                  <input type="radio" id="rate3" name="rating" value="3" />
                  <label for="rate3" title="Average">3 stars</label>
                  <input type="radio" id="rate2" name="rating" value="2" />
                  <label for="rate2" title="Not good">2 stars</label>
                  <input type="radio" id="rate1" name="rating" value="1" />
                  <label for="rate1" title="Terrible">1 star</label>
                </fieldset>
                <textarea id="reviewComment" placeholder="${tr("Write your comment...", "अपनी टिप्पणी लिखें...")}"></textarea>
                <button class="btn" onclick="submitReview('${hospital.name.replace(
                  /'/g,
                  "\\'"
                )}')">${tr("Submit Review", "समीक्षा जमा करें")}</button>
              </div>
            </div>
          </div>
        `;
        const modal = document.getElementById("hospitalModal");
        modal.style.display = "flex";
        modal.classList.add("open");
        setTimeout(() => {
          try {
            if (map) {
              map.remove();
              map = null;
            }
            map = L.map("map").setView([hospital.lat, hospital.lon], 14);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "© OpenStreetMap contributors",
            }).addTo(map);
            L.marker([hospital.lat, hospital.lon])
              .addTo(map)
              .bindPopup(hospital.name);
          } catch {}
          initCharts(hospital);
          renderReviews(hospital.name);
        }, 50);
      }

      function startRoutingInModal(lat, lon) {
        if (routeControlInModal && routeMapInstance) {
          routeControlInModal.remove();
          routeMapInstance.remove();
          routeControlInModal = null;
          routeMapInstance = null;
        }
        const el = document.getElementById("routeMap");
        if (!userLat || !userLon) {
          el.innerHTML = "Enable location and search first.";
          return;
        }
        routeMapInstance = L.map("routeMap").setView([lat, lon], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(routeMapInstance);
        routeControlInModal = L.Routing.control({
          waypoints: [L.latLng(userLat, userLon), L.latLng(lat, lon)],
          routeWhileDragging: false,
          addWaypoints: false,
          showAlternatives: true,
          fitSelectedRoutes: true,
        }).addTo(routeMapInstance);
      }

      function closeHospitalModal() {
        const modal = document.getElementById("hospitalModal");
        modal.classList.remove("open");
        modal.style.display = "none";
        if (map) {
          map.remove();
          map = null;
        }
        if (routeControlInModal) {
          routeControlInModal.remove();
          routeControlInModal = null;
        }
        if (routeMapInstance) {
          routeMapInstance.remove();
          routeMapInstance = null;
        }
        if (bedChart) {
          bedChart.destroy();
          bedChart = null;
        }
        if (waitChart) {
          waitChart.destroy();
          waitChart = null;
        }
      }

      function initCharts(h) {
        const bedCtx = document.getElementById("bedPie");
        const waitCtx = document.getElementById("waitBar");

        if (bedChart) bedChart.destroy();
        bedChart = new Chart(bedCtx, {
          type: "pie",
          data: {
            labels: [tr("Available", "उपलब्ध"), tr("Occupied", "कब्जे में")],
            datasets: [
              {
                data: [h.details.availableBeds, h.details.occupiedBeds],
                backgroundColor: ["#28a745", "#dc3545"],
              },
            ],
          },
          options: { plugins: { legend: { position: "bottom" } } },
        });

        const waits = Array.from({ length: 7 }, () =>
          Math.max(
            5,
            Math.round(h.details.waitTime + (Math.random() - 0.5) * 6)
          )
        );
        if (waitChart) waitChart.destroy();
        waitChart = new Chart(waitCtx, {
          type: "bar",
          data: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                label: tr("Avg wait (min)", "औसत प्रतीक्षा (मिनट)"),
                data: waits,
                backgroundColor: "#0d6efd",
              },
            ],
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } },
          },
        });
      }

      function openExternalMap(lat, lon, name) {
        const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}(${encodeURIComponent(
          name
        )})`;
        window.open(url, "_blank");
      }
      function openExternalOsm(lat, lon) {
        const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=16/${lat}/${lon}`;
        window.open(url, "_blank");
      }
      function initPreviewMap(elId, lat, lon) {
        try {
          const el = document.getElementById(elId);
          if (!el) return;
          const pm = L.map(elId, {
            zoomControl: false,
            attributionControl: false,
          }).setView([lat, lon], 13);
          L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          ).addTo(pm);
          L.marker([lat, lon]).addTo(pm);
        } catch {}
      }
      function getDirections(lat, lon) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const url = `https://www.google.com/maps/dir/${pos.coords.latitude},${pos.coords.longitude}/${lat},${lon}`;
              window.open(url, "_blank");
            },
            () => {
              const url = `https://www.google.com/maps/dir//${lat},${lon}`;
              window.open(url, "_blank");
            },
            { timeout: 8000 }
          );
        } else {
          const url = `https://www.google.com/maps/dir//${lat},${lon}`;
          window.open(url, "_blank");
        }
      }
      function toggleHeaderMenu() {
        const a = document.querySelector(".header-actions");
        if (!a) return;
        if (a.classList.contains("open")) a.classList.remove("open");
        else a.classList.add("open");
      }
      function callHospital(phoneNumber) {
        window.location.href = `tel:${phoneNumber}`;
      }
      function openBooking(name) {
        window.open(
          `https://www.google.com/search?q=${encodeURIComponent(
            name
          )}+online+appointment`,
          "_blank"
        );
      }

      // Nearby via Overpass (modal list)
      async function loadNearby(hName, lat, lon, type) {
        const list = document.getElementById("nearbyList");
        list.innerHTML = "Loading nearby...";
        let query = "";
        if (type === "pharmacy")
          query = `node["amenity"="pharmacy"](around:1500,${lat},${lon});`;
        else if (type === "clinic")
          query = `node["amenity"="clinic"](around:1500,${lat},${lon});`;
        else if (type === "blood_bank")
          query = `node["healthcare"="blood_donation"](around:3000,${lat},${lon}); node["amenity"="blood_bank"](around:3000,${lat},${lon});`;
        else if (type === "public_transport")
          query = `node["public_transport"](around:2000,${lat},${lon}); node["railway"="station"](around:3000,${lat},${lon}); node["subway"="yes"](around:3000,${lat},${lon});`;
        const overpassQuery = `[out:json][timeout:25]; (${query}); out center;`;
        try {
          const res = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: overpassQuery,
          });
          const data = await res.json();
          if (!data.elements || data.elements.length === 0) {
            list.innerHTML = "No nearby places found.";
            return;
          }
          list.innerHTML = data.elements
            .slice(0, 15)
            .map((e) => {
              const nm = e.tags?.name || "Unnamed";
              const dist =
                userLat && userLon
                  ? getDistance(userLat, userLon, e.lat, e.lon)
                  : "—";
              return `<div class="detail-row"><span>${nm}</span><span>${
                typeof dist === "number" ? dist.toFixed(1) + " km" : ""
              }</span></div>`;
            })
            .join("");
        } catch {
          list.innerHTML = "Failed to load nearby places.";
        }
      }

      // Crowd wait submission
      function submitWaitTime(hName) {
        const input = document.getElementById("crowdWait");
        const val = Number(input.value);
        if (!val && val !== 0) {
          alert("Enter a valid number");
          return;
        }
        const h = allHospitals.find((x) => x.name === hName);
        if (!h) return;
        h.details.waitTime = Math.round((h.details.waitTime + val) / 2);
        alert("Thank you! Wait time updated.");
        openHospitalModal(h);
      }
      function simulateBedApi(hName) {
        const h = allHospitals.find((x) => x.name === hName);
        if (!h) return;
        const delta = Math.round((Math.random() - 0.5) * 10);
        h.details.availableBeds = Math.max(0, h.details.availableBeds + delta);
        h.details.occupiedBeds = Math.max(
          0,
          h.details.totalBeds - h.details.availableBeds
        );
        alert("Synced with state API (simulated).");
        openHospitalModal(h);
      }

      // Reviews with Starability
      function getReviews() {
        try {
          return JSON.parse(localStorage.getItem(REVIEWS_KEY) || "{}");
        } catch {
          return {};
        }
      }
      // Simple Hindi transliteration for names (fallback); for production use a robust library
      function translateHospitalName(name) {
        if (currentLang() !== "hi") return name;
        try {
          // Very basic mapping; can be replaced with open-source transliteration
          const map = {
            a: "अ",
            b: "ब",
            c: "क",
            d: "ड",
            e: "ए",
            f: "फ",
            g: "ग",
            h: "ह",
            i: "इ",
            j: "ज",
            k: "क",
            l: "ल",
            m: "म",
            n: "न",
            o: "ओ",
            p: "प",
            q: "क",
            r: "र",
            s: "स",
            t: "ट",
            u: "उ",
            v: "व",
            w: "व",
            x: "क्स",
            y: "य",
            z: "ज",
          };
          return name
            .split("")
            .map((ch) => {
              const lower = ch.toLowerCase();
              if (map[lower]) return map[lower];
              return ch;
            })
            .join("");
        } catch {
          return name;
        }
      }
      function saveReviews(obj) {
        try {
          localStorage.setItem(REVIEWS_KEY, JSON.stringify(obj));
        } catch {}
      }
      function renderReviews(hName) {
        const wrap = document.getElementById("reviewsWrap");
        const all = getReviews();
        const arr = all[hName] || [];
        if (!arr.length) {
          wrap.innerHTML = '<div class="review">No reviews yet.</div>';
          return;
        }
        wrap.innerHTML = arr
          .map(
            (r) =>
              `<div class="review"><div class="starability-result" data-rating="${
                r.rating
              }"></div><div>${
                r.comment
              }</div><div style="font-size:12px;color:var(--muted);margin-top:4px;">${new Date(
                r.ts
              ).toLocaleString()}</div></div>`
          )
          .join("");
      }
      function currentSelectedStars() {
        for (let i = 5; i >= 1; i--) {
          const el = document.getElementById("rate" + i);
          if (el && el.checked) return i;
        }
        return 0;
      }
      function submitReview(hName) {
        const rating = currentSelectedStars();
        const comment = document.getElementById("reviewComment").value.trim();
        if (!rating || !comment) {
          alert("Please add rating and comment.");
          return;
        }
        const all = getReviews();
        all[hName] = all[hName] || [];
        all[hName].push({ rating, comment, ts: Date.now() });
        saveReviews(all);
        document.getElementById("reviewComment").value = "";
        // reset stars
        for (let i = 1; i <= 5; i++) {
          const el = document.getElementById("rate" + i);
          if (el) el.checked = false;
        }
        renderReviews(hName);
        // Update hospital rating roughly
        const h = allHospitals.find((x) => x.name === hName);
        if (h) {
          const ratings = all[hName].map((x) => x.rating);
          const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length;
          h.details.rating = avg.toFixed(1);
          applyFilters();
        }
      }

      // Compare
      function toggleCompare(e, name) {
        e.stopPropagation();
        if (compareSet.has(name)) compareSet.delete(name);
        else compareSet.add(name);
        renderCompareBar();
        applyFilters();
      }
      function renderCompareBar() {
        const bar = document.getElementById("compareBar");
        const items = document.getElementById("compareItems");
        items.innerHTML = "";
        compareSet.forEach((n) => {
          const p = document.createElement("span");
          p.className = "pill";
          p.textContent = n;
          items.appendChild(p);
        });
        bar.style.display = compareSet.size ? "block" : "none";
      }
      function openCompare() {
        const body = document.getElementById("compareBody");
        const sel = allHospitals
          .filter((h) => compareSet.has(h.name))
          .slice(0, 3);
        if (!sel.length) {
          body.innerHTML = "Select hospitals to compare.";
        } else {
          const head = `<div style="display:grid; grid-template-columns: repeat(${
            sel.length
          }, 1fr); gap:8px; font-weight:800;">
            ${sel.map((h) => `<div>${h.name}</div>`).join("")}</div>`;
          const row = (
            label,
            getter
          ) => `<div style="display:grid; grid-template-columns: repeat(${
            sel.length
          }, 1fr); gap:8px; border-top:1px solid var(--border); padding-top:6px;">
              ${sel
                .map((h) => `<div><b>${label}:</b> ${getter(h)}</div>`)
                .join("")}
            </div>`;
          body.innerHTML =
            head +
            row("Distance", (h) => `${h.distance} km`) +
            row("Available Beds", (h) => h.details.availableBeds) +
            row("Rating", (h) => h.details.rating) +
            row("Type", (h) => (h.isEmergency ? "Emergency" : "General")) +
            row("Facilities", (h) =>
              h.details.facilities.slice(0, 4).join(", ")
            );
          // Optional radar chart could be added similarly with Chart.js if desired
        }
        document.getElementById("compareModal").style.display = "flex";
      }
      function closeCompare() {
        document.getElementById("compareModal").style.display = "none";
      }
      function clearCompare() {
        compareSet.clear();
        renderCompareBar();
        applyFilters();
      }

      // Chatbot removed

      // Sign-in/Profile (local only)
      document
        .getElementById("signForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const profile = {
            email: document.getElementById("email").value,
            name: document.getElementById("profileName").value,
            phone: document.getElementById("profilePhone").value,
            prefs: {
              type: currentTypeFilter,
              specialty: currentSpecialtyFilter,
            },
          };
          localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
          alert("Signed in locally. Preferences saved on this device.");
          closeSignInModal();
        });
      function openSignInModal() {
        document.getElementById("signModal").style.display = "flex";
        document.getElementById("email").focus();
      }
      function closeSignInModal() {
        document.getElementById("signModal").style.display = "none";
      }

      // Data
      async function findHospitals() {
        // Search by Location
        showLoader();
        const landing = document.getElementById("landing");
        if (landing) landing.style.display = "none";
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by this browser.");
          hideLoader();
          return;
        }
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            // Store user's real location globally for accurate distance calculations
            window.userRealLat = userLat;
            window.userRealLon = userLon;

            try {
              const overpassQuery = `
              [out:json][timeout:25];
              (
                node["amenity"="hospital"](around:20000,${userLat},${userLon});
                way["amenity"="hospital"](around:20000,${userLat},${userLon});
                relation["amenity"="hospital"](around:20000,${userLat},${userLon});
              );
              out center meta;
            `;
              const url = "https://overpass-api.de/api/interpreter";
              const response = await fetch(url, {
                method: "POST",
                body: overpassQuery,
              });
              if (!response.ok)
                throw new Error("Failed to fetch hospital data");

              const data = await response.json();
              if (!data.elements || data.elements.length === 0) {
                allHospitals = await generateSampleHospitals(userLat, userLon);
              } else {
                allHospitals = data.elements.map((element, idx) => {
                  const hospitalLat =
                    element.lat ||
                    element.center?.lat ||
                    userLat + (Math.random() - 0.5) * 0.1;
                  const hospitalLon =
                    element.lon ||
                    element.center?.lon ||
                    userLon + (Math.random() - 0.5) * 0.1;
                  const isEm = isEmergencyHospital(element.tags);
                  const specialties = generateSpecialties(isEm);
                  const name = element.tags?.name || `Hospital ${idx + 1}`;
                  const image = getHospitalImage(name);
                  const distance = getDistance(
                    userLat,
                    userLon,
                    hospitalLat,
                    hospitalLon
                  );
                  return {
                    name,
                    lat: hospitalLat,
                    lon: hospitalLon,
                    distance,
                    isEmergency: isEm,
                    image,
                    details: {
                      ...generateHospitalDetails(isEm, distance, specialties),
                      address: composeAddress(element.tags),
                    },
                    tags: element.tags || {},
                  };
                });
              }

              allHospitals.sort((a, b) => a.distance - b.distance);
              displayHospitals(allHospitals);
              updateStats(allHospitals);
              document.getElementById("filterSection").style.display = "block";
              document.getElementById("statsSection").style.display = "flex";
              // no homepage map
              document.body.classList.add("with-results");
              showAdvancedFilters();
              // Setup desktop layout after showing results
              setTimeout(setupDesktopLayout, 100);
            } catch (error) {
              console.error("Error fetching hospitals:", error);
              allHospitals = await generateSampleHospitals(userLat, userLon);
              displayHospitals(allHospitals);
              updateStats(allHospitals);
              document.getElementById("filterSection").style.display = "block";
              document.getElementById("statsSection").style.display = "flex";
              // no homepage map
              document.body.classList.add("with-results");
              showAdvancedFilters();
              // Setup desktop layout after showing results
              setTimeout(setupDesktopLayout, 100);
            } finally {
              hideLoader();
              applyFilters();
            }
          },
          (error) => {
            console.error("Geolocation error:", error);
            alert(
              "Error getting your location. Please enable location services and try again."
            );
            hideLoader();
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
      }

      // Enhanced search by name or city using open data (Nominatim + Overpass)
      async function searchHospitals() {
        const q = document.getElementById("searchInput").value.trim();
        if (!q) {
          alert("Please enter a hospital name or city to search.");
          return;
        }
        
        showLoader();
        renderSkeletons(8);
        const landing = document.getElementById("landing");
        if (landing) landing.style.display = "none";
        
        try {
          // First, check if it's a valid city/area using geocoding
          const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5&addressdetails=1`;
          const geoRes = await fetch(geocodeUrl, {
            headers: { Accept: "application/json" },
          });
          const places = await geoRes.json();
          
          // Check if any result is a city, town, village, or administrative area
          const validPlace = places.find(place => {
            const type = place.type;
            const category = place.class;
            return (
              type === 'city' || type === 'town' || type === 'village' || 
              type === 'municipality' || type === 'administrative' ||
              category === 'place' || category === 'boundary'
            );
          });
          
          if (validPlace) {
            // It's a valid city/area - search for all hospitals in that location
            const centerLat = parseFloat(validPlace.lat);
            const centerLon = parseFloat(validPlace.lon);
            userLat = centerLat;
            userLon = centerLon;
            
            const overpassQuery = `
              [out:json][timeout:25];
              (
                node["amenity"="hospital"](around:20000,${centerLat},${centerLon});
                way["amenity"="hospital"](around:20000,${centerLat},${centerLon});
                relation["amenity"="hospital"](around:20000,${centerLat},${centerLon});
              );
              out center meta;
            `;
            
            const response = await fetch(
              "https://overpass-api.de/api/interpreter",
              { method: "POST", body: overpassQuery }
            );
            const data = await response.json();
            const elements = data && data.elements ? data.elements : [];
            
            if (!elements.length) {
              alert(`No hospitals found in ${validPlace.display_name}. Try searching in a nearby city.`);
              hideLoader();
              return;
            }
            
            allHospitals = elements.map((element, idx) => {
              const hospitalLat = element.lat || element.center?.lat || centerLat + (Math.random() - 0.5) * 0.05;
              const hospitalLon = element.lon || element.center?.lon || centerLon + (Math.random() - 0.5) * 0.05;
              const isEm = isEmergencyHospital(element.tags);
              const specialties = generateSpecialties(isEm);
              const name = element.tags?.name || `Hospital ${idx + 1}`;
              const image = getHospitalImage(name);
              
              // Always calculate distance from user's actual location, not search center
              // Store user's real location globally when they first use geolocation
              const distance = getDistance(
                window.userRealLat || userLat, 
                window.userRealLon || userLon, 
                hospitalLat, 
                hospitalLon
              );
              
              return {
                name,
                lat: hospitalLat,
                lon: hospitalLon,
                distance,
                isEmergency: isEm,
                image,
                details: {
                  ...generateHospitalDetails(isEm, distance, specialties),
                  address: composeAddress(element.tags),
                },
                tags: element.tags || {},
              };
            });
            
          } else {
            // Not a valid city - try searching for hospitals by name
            const hospitalNameQuery = `
              [out:json][timeout:25];
              (
                node["amenity"="hospital"]["name"~"${q}",i];
                way["amenity"="hospital"]["name"~"${q}",i];
                relation["amenity"="hospital"]["name"~"${q}",i];
              );
              out center meta;
            `;
            
            const hospitalResponse = await fetch(
              "https://overpass-api.de/api/interpreter",
              { method: "POST", body: hospitalNameQuery }
            );
            const hospitalData = await hospitalResponse.json();
            const hospitalElements = hospitalData && hospitalData.elements ? hospitalData.elements : [];
            
            if (!hospitalElements.length) {
              alert(`No hospitals or cities found matching "${q}". Please check your spelling and try again.`);
              hideLoader();
              return;
            }
            
            // Calculate center point from found hospitals
            let avgLat = 0, avgLon = 0;
            hospitalElements.forEach(element => {
              avgLat += element.lat || element.center?.lat || 0;
              avgLon += element.lon || element.center?.lon || 0;
            });
            userLat = avgLat / hospitalElements.length;
            userLon = avgLon / hospitalElements.length;
            
            allHospitals = hospitalElements.map((element, idx) => {
              const hospitalLat = element.lat || element.center?.lat || userLat;
              const hospitalLon = element.lon || element.center?.lon || userLon;
              const isEm = isEmergencyHospital(element.tags);
              const specialties = generateSpecialties(isEm);
              const name = element.tags?.name || `Hospital ${idx + 1}`;
              const image = getHospitalImage(name);
              const distance = getDistance(userLat, userLon, hospitalLat, hospitalLon);
              
              return {
                name,
                lat: hospitalLat,
                lon: hospitalLon,
                distance,
                isEmergency: isEm,
                image,
                details: {
                  ...generateHospitalDetails(isEm, distance, specialties),
                  address: composeAddress(element.tags),
                },
                tags: element.tags || {},
              };
            });
          }
          
          // Sort and display results
          allHospitals.sort((a, b) => a.distance - b.distance);
          displayHospitals(allHospitals);
          updateStats(allHospitals);
          document.getElementById("filterSection").style.display = "block";
          document.getElementById("statsSection").style.display = "flex";
          showAdvancedFilters();
          document.body.classList.add("with-results");
          setTimeout(setupDesktopLayout, 100);
        } catch (e) {
          console.error(e);
          alert("Search failed. Please try again.");
        } finally {
          hideLoader();
          applyFilters();
        }
      }

      // Autocomplete functionality
      async function showAutocomplete(query) {
        try {
          const dropdown = document.getElementById("autocompleteDropdown");
          if (!dropdown) {
            console.log("Dropdown element not found");
            return;
          }
          
          console.log("Searching autocomplete for:", query);
          
          // Clear dropdown first
          dropdown.innerHTML = "";
          
          // Search for cities/places with better error handling
          let places = [];
          try {
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`;
            const geoRes = await fetch(geocodeUrl, {
              headers: { 
                Accept: "application/json",
                "User-Agent": "HosiTat Hospital Finder"
              },
            });
            
            if (geoRes.ok) {
              places = await geoRes.json();
              console.log("Found places:", places.length);
            }
          } catch (e) {
            console.log("Geocoding error:", e);
          }
          
          // Add city suggestions
          const validPlaces = places.filter(place => {
            const type = place.type;
            const category = place.class;
            const name = place.display_name;
            return (
              name && (
                type === 'city' || type === 'town' || type === 'village' || 
                type === 'municipality' || type === 'administrative' ||
                category === 'place' || category === 'boundary'
              )
            );
          }).slice(0, 4);
          
          validPlaces.forEach(place => {
            const placeName = place.display_name.split(',')[0];
            const item = document.createElement("div");
            item.className = "autocomplete-item";
            item.innerHTML = `
              <span class="autocomplete-text">${placeName}</span>
              <span class="autocomplete-type city">CITY</span>
            `;
            item.addEventListener("click", () => {
              document.getElementById("searchInput").value = placeName;
              hideAutocomplete();
            });
            dropdown.appendChild(item);
          });
          
          // Add some sample hospital suggestions for now (since Overpass might be slow)
          const sampleHospitals = [
            "General Hospital", "City Medical Center", "Regional Hospital", 
            "Emergency Care Center", "Community Hospital"
          ].filter(name => name.toLowerCase().includes(query.toLowerCase())).slice(0, 3);
          
          sampleHospitals.forEach(name => {
            const item = document.createElement("div");
            item.className = "autocomplete-item";
            item.innerHTML = `
              <span class="autocomplete-text">${name}</span>
              <span class="autocomplete-type hospital">HOSPITAL</span>
            `;
            item.addEventListener("click", () => {
              document.getElementById("searchInput").value = name;
              hideAutocomplete();
            });
            dropdown.appendChild(item);
          });
          
          // Show dropdown if we have suggestions
          if (dropdown.children.length > 0) {
            dropdown.style.display = "block";
            console.log("Showing dropdown with", dropdown.children.length, "items");
          } else {
            dropdown.style.display = "none";
            console.log("No suggestions found");
          }
          
        } catch (error) {
          console.error("Autocomplete error:", error);
          hideAutocomplete();
        }
      }
      
      function hideAutocomplete() {
        const dropdown = document.getElementById("autocompleteDropdown");
        if (dropdown) {
          dropdown.style.display = "none";
        }
      }

      function composeAddress(tags = {}) {
        const parts = [
          tags["addr:housenumber"],
          tags["addr:street"],
          tags["addr:suburb"],
          tags["addr:city"],
          tags["addr:state"],
          tags["addr:postcode"],
        ];
        return parts.filter(Boolean).join(", ") || tr("Address unavailable", "पता उपलब्ध नहीं");
      }

      async function generateSampleHospitals(userLat, userLon) {
        const sampleHospitals = [
          { name: "City General Hospital", isEmergency: true },
          { name: "St. Mary's Medical Center", isEmergency: false },
          { name: "Metro Emergency Hospital", isEmergency: true },
          { name: "Central Healthcare Institute", isEmergency: false },
          { name: "Regional Trauma Center", isEmergency: true },
          { name: "Community Medical Hospital", isEmergency: false },
          { name: "Advanced Care Hospital", isEmergency: false },
          { name: "Emergency Care Center", isEmergency: true },
        ];
        const results = [];
        for (const hospital of sampleHospitals) {
          const lat = userLat + (Math.random() - 0.5) * 0.1;
          const lon = userLon + (Math.random() - 0.5) * 0.1;
          const specialties = generateSpecialties(hospital.isEmergency);
          const image = getHospitalImage(hospital.name);
          const distance = getDistance(userLat, userLon, lat, lon);
          results.push({
            name: hospital.name,
            lat,
            lon,
            distance,
            isEmergency: hospital.isEmergency,
            image,
            details: {
              ...generateHospitalDetails(
                hospital.isEmergency,
                distance,
                specialties
              ),
              address: "Sample Address",
            },
            tags: { name: hospital.name, amenity: "hospital" },
          });
        }
        return results;
      }

      // Modals and keyboard
      document.addEventListener("click", function (e) {
        if (e.target.id === "hospitalModal") closeHospitalModal();
        if (e.target.id === "signModal") closeSignInModal();
        if (e.target.id === "compareModal") closeCompare();
      });
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeHospitalModal();
          closeSignInModal();
          closeCompare();
        }
      });

      // PWA: create manifest + service worker on the fly
      (function setupPWA() {
        if (!("serviceWorker" in navigator)) return;
        const manifest = {
          name: "HosiTat",
          short_name: "HosiTat",
          start_url: ".",
          display: "standalone",
          background_color: "#121212",
          theme_color: "#dc3545",
          icons: [
            {
              src: "https://via.placeholder.com/192x192.png?text=H",
              sizes: "192x192",
              type: "image/png",
            },
            {
              src: "https://via.placeholder.com/512x512.png?text=H",
              sizes: "512x512",
              type: "image/png",
            },
          ],
        };
        const blob = new Blob([JSON.stringify(manifest)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = url;
        document.head.appendChild(link);

        const swCode = `
          const CACHE = 'hositat-cache-v1';
          const ASSETS = [
            self.location.href
          ];
          self.addEventListener('install', (e) => {
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));
            self.skipWaiting();
          });
          self.addEventListener('activate', (e) => { e.waitUntil(self.clients.claim()); });
          self.addEventListener('fetch', (e) => {
            const url = new URL(e.request.url);
            if (url.origin === location.origin) {
              e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
                const copy = res.clone();
                caches.open(CACHE).then(c=>c.put(e.request, copy));
                return res;
              })));
            }
          });
          // Offline last results endpoint for demo
          self.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'CACHE_LAST_RESULTS') {
              caches.open(CACHE).then(c => {
                const blob = new Blob([e.data.payload], { type:'application/json' });
                const resp = new Response(blob, { headers: { 'Content-Type':'application/json' }});
                c.put(new Request('/offline-last-results.json'), resp);
              });
            }
          });
        `;
        const swBlob = new Blob([swCode], { type: "application/javascript" });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(() => {});
      })();

      // Mobile filter toggle functionality
      function toggleMobileFilters() {
        const filtersWrap = document.getElementById('advancedFilters');
        const toggleText = document.getElementById('filterToggleText');
        const toggleIcon = document.getElementById('filterToggleIcon');
        const toggleBtn = document.querySelector('.mobile-filter-toggle');
        
        if (filtersWrap.classList.contains('show')) {
          filtersWrap.classList.remove('show');
          toggleText.textContent = 'Show Filters';
          toggleIcon.textContent = '▼';
          toggleBtn.classList.remove('active');
        } else {
          filtersWrap.classList.add('show');
          toggleText.textContent = 'Hide Filters';
          toggleIcon.textContent = '▲';
          toggleBtn.classList.add('active');
        }
      }
      
      // Move only advanced filters to left column on desktop
      function setupDesktopLayout() {
        const isDesktop = window.innerWidth > 900;
        const leftColumn = document.querySelector('.left-column');
        const advancedFilters = document.getElementById('advancedFilters');
        const statsSection = document.getElementById('statsSection');
        const filterSection = document.getElementById('filterSection');
        
        if (isDesktop && document.body.classList.contains('with-results')) {
          // Only move advanced filters to left column on desktop
          if (advancedFilters && advancedFilters.parentNode !== leftColumn) {
            leftColumn.appendChild(advancedFilters);
          }
          // Keep stats and filter sections in their original positions
        } else {
          // Keep original positions on mobile
          const mainContainer = document.querySelector('main') || document.body;
          if (advancedFilters && advancedFilters.parentNode === leftColumn) {
            mainContainer.insertBefore(advancedFilters, document.querySelector('.main-layout'));
          }
        }
      }
      
      // Setup layout on window resize
      window.addEventListener('resize', setupDesktopLayout);
      window.addEventListener('load', setupDesktopLayout);

      // Keep offline cache updated with last results
      function sendResultsToSW(jsonStr) {
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: "CACHE_LAST_RESULTS",
            payload: jsonStr,
          });
        }
      }

      // Init
      document.addEventListener("DOMContentLoaded", () => {
        // initTheme();
        // translateUI(currentLang());
        const lang = localStorage.getItem(LANG_KEY) || "en";
        setLang(lang);
        hideLoader();
        renderHistory();
        document.getElementById("filterSection").style.display = "none";
        document.getElementById("statsSection").style.display = "none";
        const adv = document.getElementById("advancedFilters");
        if (adv) adv.style.display = "none";
        const si = document.getElementById("searchInput");
        if (si) {
          si.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              searchHospitals();
            }
          });
          
          // Add autocomplete functionality
          let autocompleteTimeout;
          si.addEventListener("input", (e) => {
            clearTimeout(autocompleteTimeout);
            const query = e.target.value.trim();
            
            console.log("Input event triggered, query:", query);
            
            if (query.length < 2) {
              hideAutocomplete();
              return;
            }
            
            autocompleteTimeout = setTimeout(() => {
              console.log("Calling showAutocomplete for:", query);
              showAutocomplete(query);
            }, 300);
          });
          
          // Prevent form submission when selecting autocomplete
          si.addEventListener("keydown", (e) => {
            if (e.key === "ArrowDown" || e.key === "ArrowUp") {
              e.preventDefault();
            }
          });
          
          // Hide autocomplete when clicking outside
          document.addEventListener("click", (e) => {
            if (!e.target.closest(".search-input-container")) {
              hideAutocomplete();
            }
          });
        }
        // Setup desktop layout
        setupDesktopLayout();
        // If we have last results, push to SW cache
        try {
          const last = localStorage.getItem("hositat_last_results");
          if (last) sendResultsToSW(last);
        } catch {}
      });
    </script>
  </body>
</html>
